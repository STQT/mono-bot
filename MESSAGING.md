# Система отправки сообщений

## Описание

Реализована система массовых и персональных уведомлений с учетом лимитов Telegram API и отслеживанием активности пользователей.

## Функционал

### 1. Отслеживание активности пользователей

- Поле `is_active` в модели `TelegramUser` - помечает активных пользователей
- Поле `last_message_sent_at` - время последней успешной отправки
- Поле `blocked_bot_at` - время блокировки бота пользователем
- Автоматическое обновление статуса при отправке сообщений

### 2. Массовые рассылки (Broadcast)

- Создание рассылок через админку
- Фильтрация по типу пользователя (электрики/продавцы)
- Учет лимитов Telegram API (30 сообщений в секунду)
- Автоматическое помечание неактивных пользователей
- Статистика отправки (отправлено/ошибок)

### 3. Персональные сообщения

- Отправка сообщений конкретным пользователям
- Поддержка HTML и Markdown форматирования
- Обработка ошибок (блокировка бота, неактивные пользователи)

## Использование

### Массовая рассылка через админку

1. Перейдите в раздел "Рассылки" в админке
2. Создайте новую рассылку:
   - Укажите название
   - Введите текст сообщения
   - Выберите фильтр по типу пользователя (опционально)
3. Выберите рассылку и нажмите "Отправить выбранные рассылки"

### Массовая рассылка через команду

```bash
python manage.py send_broadcast <broadcast_id>
```

### Персональное сообщение через админку

1. Перейдите в раздел "Пользователи Telegram"
2. Выберите пользователей
3. Выберите действие "Отправить персональное сообщение выбранным пользователям"
4. Введите текст сообщения
5. Выберите режим парсинга (опционально)

### Персональное сообщение через команду

```bash
python manage.py send_message <telegram_id> "Текст сообщения" [--parse-mode HTML]
```

## Лимиты Telegram API

- **30 сообщений в секунду** для broadcast рассылок
- Автоматическая задержка между сообщениями (~0.033 секунды)
- Обработка ошибок rate limiting

## Обработка ошибок

### Пользователь заблокировал бота
- Автоматически помечается как неактивный (`is_active = False`)
- Устанавливается `blocked_bot_at`
- Не будет получать дальнейшие рассылки

### Ошибки отправки
- Логируются в систему
- Учитываются в статистике рассылки
- Пользователь помечается как неактивный при критических ошибках

## Модели данных

### TelegramUser (обновлено)
- `is_active` - активен ли пользователь
- `last_message_sent_at` - время последней отправки
- `blocked_bot_at` - время блокировки бота

### BroadcastMessage (новая)
- `title` - название рассылки
- `message_text` - текст сообщения
- `user_type_filter` - фильтр по типу пользователя
- `status` - статус рассылки
- `total_users` - всего пользователей
- `sent_count` - отправлено
- `failed_count` - ошибок
- `created_at`, `started_at`, `completed_at` - даты

## API функций

### send_message_to_user()
Отправляет сообщение конкретному пользователю с обработкой ошибок.

### send_broadcast_message()
Отправляет массовое сообщение всем активным пользователям с учетом лимитов.

### send_personal_message()
Отправляет персональное сообщение по telegram_id.

## Безопасность

- Проверка активности пользователей перед отправкой
- Обработка всех типов ошибок Telegram API
- Логирование всех операций
- Защита от спама через отслеживание неактивных пользователей

