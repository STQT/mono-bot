<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–æ–∏ –ø–æ–¥–∞—Ä–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .points-display {
            font-size: 32px;
            font-weight: bold;
            margin: 8px 0;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 16px;
            color: var(--tg-theme-text-color, #000000);
        }

        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .gift-card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }

        .gift-card:hover {
            transform: scale(1.05);
        }

        .gift-card.available {
            border-color: var(--tg-theme-button-color, #3390ec);
        }

        .gift-card.unavailable {
            opacity: 0.6;
        }

        .gift-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .gift-name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .gift-cost {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .redemption-item {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .redemption-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .redemption-gift-name {
            font-size: 18px;
            font-weight: bold;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #ffa500;
            color: white;
        }

        .status-approved {
            background: #4caf50;
            color: white;
        }

        .status-sent {
            background: #2196f3;
            color: white;
        }

        .status-delivered {
            background: #4caf50;
            color: white;
        }

        .status-rejected {
            background: #f44336;
            color: white;
        }

        .status-completed {
            background: #9c27b0;
            color: white;
        }

        .delivery-info {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .delivery-status {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .confirm-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.7;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }

        .comment-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 8px;
            margin-top: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .phone-number {
            margin-top: 8px;
            font-size: 14px;
            color: var(--tg-theme-button-color, #3390ec);
            text-decoration: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 16px;
            padding: 24px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="font-size: 16px; opacity: 0.9;">–í–∞—à–∏ –±–∞–ª–ª—ã</div>
            <div class="points-display" id="points">0</div>
            <div style="font-size: 14px; opacity: 0.8;" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div id="errorContainer"></div>

        <div class="section">
            <div class="section-title">üéÅ –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</div>
            <div class="gifts-grid" id="giftsContainer">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–∞—Ä–∫–æ–≤...</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
            <div id="redemptionsContainer">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è</div>
            <p>–í—ã –ø–æ–ª—É—á–∏–ª–∏ –∑–∞–∫–∞–∑?</p>
            <textarea class="comment-input" id="commentInput" placeholder="–ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∏ –ø—Ä–æ—Å—å–±—É –ø–æ–∑–≤–æ–Ω–∏—Ç—å..."></textarea>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="confirmDelivery(true)">–î–∞, –ø–æ–ª—É—á–∏–ª</button>
                <button class="btn btn-danger" onclick="confirmDelivery(false)">–ù–µ—Ç, –Ω–µ –ø–æ–ª—É—á–∏–ª</button>
                <button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let currentUser = null;
        let currentRedemptionId = null;
        const API_BASE = '/api/webapp';

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ initData
        async function initApp() {
            try {
                const initData = tg.initDataUnsafe;
                const user = initData.user;
                
                if (!user || !user.id) {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return;
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userResponse = await fetch(`${API_BASE}/user/?telegram_id=${user.id}`);
                if (!userResponse.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
                currentUser = await userResponse.json();
                
                document.getElementById('points').textContent = currentUser.points;
                document.getElementById('userName').textContent = currentUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∞—Ä–∫–∏ –∏ –∑–∞–∫–∞–∑—ã
                await loadGifts();
                await loadRedemptions();
            } catch (error) {
                console.error('Error initializing app:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        async function loadGifts() {
            try {
                const response = await fetch(`${API_BASE}/gifts/`);
                if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏');
                
                const gifts = await response.json();
                const container = document.getElementById('giftsContainer');
                
                if (gifts.length === 0) {
                    container.innerHTML = '<div class="loading">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ–¥–∞—Ä–∫–æ–≤</div>';
                    return;
                }

                container.innerHTML = gifts.map(gift => {
                    const canAfford = currentUser.points >= gift.points_cost;
                    return `
                        <div class="gift-card ${canAfford ? 'available' : 'unavailable'}" 
                             onclick="${canAfford ? `requestGift(${gift.id})` : ''}">
                            <img src="${gift.image}" alt="${gift.name}" class="gift-image" onerror="this.style.display='none'">
                            <div class="gift-name">${gift.name}</div>
                            <div class="gift-cost">${gift.points_cost} –±–∞–ª–ª–æ–≤</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading gifts:', error);
                document.getElementById('giftsContainer').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤</div>';
            }
        }

        async function loadRedemptions() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${API_BASE}/redemptions/?telegram_id=${currentUser.telegram_id}`);
                if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã');
                
                const redemptions = await response.json();
                const container = document.getElementById('redemptionsContainer');
                
                if (redemptions.length === 0) {
                    container.innerHTML = '<div class="loading">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
                    return;
                }

                container.innerHTML = redemptions.map(redemption => {
                    const statusClass = `status-${redemption.status}`;
                    const deliveryStatusClass = `status-${redemption.delivery_status}`;
                    
                    let deliveryInfo = '';
                    let confirmSection = '';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –µ—Å–ª–∏ –∑–∞–∫–∞–∑ –æ–¥–æ–±—Ä–µ–Ω
                    if (redemption.status === 'approved' || redemption.delivery_status !== 'pending') {
                        deliveryInfo = `
                            <div class="delivery-info">
                                <div class="delivery-status">
                                    –°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏: <span class="status-badge ${deliveryStatusClass}">
                                        ${getDeliveryStatusText(redemption.delivery_status)}
                                    </span>
                                </div>
                            </div>
                        `;
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –µ—Å–ª–∏ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –∏ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
                    if (redemption.delivery_status === 'delivered' && !redemption.user_confirmed) {
                        confirmSection = `
                            <div class="confirm-buttons">
                                <button class="btn btn-success" onclick="openConfirmModal(${redemption.id})">
                                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ
                                </button>
                            </div>
                        `;
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (redemption.user_comment) {
                        deliveryInfo += `
                            <div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 8px; font-size: 12px;">
                                <strong>–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${redemption.user_comment}
                            </div>
                        `;
                    }

                    return `
                        <div class="redemption-item">
                            <div class="redemption-header">
                                <div class="redemption-gift-name">${redemption.gift.name}</div>
                                <span class="status-badge ${statusClass}">${getStatusText(redemption.status)}</span>
                            </div>
                            <div style="font-size: 14px; color: var(--tg-theme-hint-color, #999999);">
                                –ó–∞–ø—Ä–æ—à–µ–Ω–æ: ${new Date(redemption.requested_at).toLocaleDateString('ru-RU')}
                            </div>
                            ${deliveryInfo}
                            ${confirmSection}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading redemptions:', error);
                document.getElementById('redemptionsContainer').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
            }
        }

        async function requestGift(giftId) {
            if (!currentUser) return;
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å —ç—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/request-gift/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: currentUser.telegram_id,
                        gift_id: giftId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–¥–∞—Ä–∫–∞');
                }

                const redemption = await response.json();
                tg.showAlert('–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                await initApp();
            } catch (error) {
                console.error('Error requesting gift:', error);
                tg.showAlert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function openConfirmModal(redemptionId) {
            currentRedemptionId = redemptionId;
            document.getElementById('confirmModal').classList.add('active');
            document.getElementById('commentInput').value = '';
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
            currentRedemptionId = null;
        }

        async function confirmDelivery(confirmed) {
            if (!currentRedemptionId) return;

            const comment = document.getElementById('commentInput').value;
            
            // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª, —Ç—Ä–µ–±—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            if (!confirmed && !comment.trim()) {
                tg.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É, –ø–æ—á–µ–º—É –≤—ã –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ –∑–∞–∫–∞–∑');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/confirm-delivery/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        redemption_id: currentRedemptionId,
                        confirmed: confirmed,
                        comment: comment
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏');
                }

                closeModal();
                
                if (confirmed) {
                    tg.showAlert('–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ!');
                } else {
                    tg.showAlert('–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è.');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑—ã
                await loadRedemptions();
            } catch (error) {
                console.error('Error confirming delivery:', error);
                tg.showAlert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        function getStatusText(status) {
            const statuses = {
                'pending': '–û–∂–∏–¥–∞–µ—Ç',
                'approved': '–û–¥–æ–±—Ä–µ–Ω–æ',
                'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ',
                'completed': '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'
            };
            return statuses[status] || status;
        }

        function getDeliveryStatusText(status) {
            const statuses = {
                'pending': '–û–∂–∏–¥–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏',
                'sent': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ'
            };
            return statuses[status] || status;
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        initApp();
    </script>
</body>
</html>

