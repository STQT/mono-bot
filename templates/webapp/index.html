{% load webapp_i18n %}
<!DOCTYPE html>
<html lang="{{ user_language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% trans "WEBAPP_MY_GIFTS" %}</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 100%;
            padding: 16px;
            padding-bottom: 80px;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .points-display {
            font-size: 32px;
            font-weight: bold;
            margin: 8px 0;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 16px;
            color: var(--tg-theme-text-color, #000000);
        }

        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .gift-card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid transparent;
        }

        .gift-card:hover {
            transform: scale(1.05);
        }

        .gift-card.available {
            border-color: var(--tg-theme-button-color, #3390ec);
        }

        .gift-card.unavailable {
            opacity: 0.6;
        }

        .gift-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .gift-name {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .gift-cost {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .redemption-item {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .redemption-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .redemption-gift-name {
            font-size: 18px;
            font-weight: bold;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #ffa500;
            color: white;
        }

        .status-approved {
            background: #4caf50;
            color: white;
        }

        .status-sent {
            background: #2196f3;
            color: white;
        }

        .status-delivered {
            background: #4caf50;
            color: white;
        }

        .status-rejected {
            background: #f44336;
            color: white;
        }

        .status-completed {
            background: #9c27b0;
            color: white;
        }

        .delivery-info {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }

        .delivery-status {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .confirm-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:active {
            opacity: 0.7;
        }

        .btn-primary {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
        }

        .comment-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 8px;
            margin-top: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .phone-number {
            margin-top: 8px;
            font-size: 14px;
            color: var(--tg-theme-button-color, #3390ec);
            text-decoration: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--tg-theme-bg-color, #ffffff);
            border-radius: 16px;
            padding: 24px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        /* Debug panel styles */
        .debug-panel {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            padding: 10px;
            margin: 10px;
            border: 2px solid #0f0;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .debug-panel h3 {
            color: #0f0;
            margin: 0 0 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="font-size: 16px; opacity: 0.9;">{% trans "WEBAPP_YOUR_POINTS" %}</div>
            <div class="points-display" id="points">0</div>
            <div style="font-size: 14px; opacity: 0.8;" id="userName">{% trans "WEBAPP_LOADING" %}</div>
        </div>

        <div id="errorContainer"></div>

        <!-- Debug Panel -->
        <div class="debug-panel" id="debugPanel">
            <h3>üîç DEBUG INFO</h3>
            <div id="debugContent">Initializing...</div>
        </div>

        <div class="section">
            <div class="section-title">{% trans "WEBAPP_AVAILABLE_GIFTS" %}</div>
            <div class="gifts-grid" id="giftsContainer">
                <div class="loading">{% trans "WEBAPP_LOADING_GIFTS" %}</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">{% trans "WEBAPP_MY_ORDERS" %}</div>
            <div id="redemptionsContainer">
                <div class="loading">{% trans "WEBAPP_LOADING_ORDERS" %}</div>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-title">{% trans "WEBAPP_CONFIRM_RECEIPT" %}</div>
            <p>{% trans "WEBAPP_DID_YOU_RECEIVE" %}</p>
            <textarea class="comment-input" id="commentInput" placeholder="{% trans 'WEBAPP_COMMENT_PLACEHOLDER' %}"></textarea>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="confirmDelivery(true)">{% trans "WEBAPP_YES_RECEIVED" %}</button>
                <button class="btn btn-danger" onclick="confirmDelivery(false)">{% trans "WEBAPP_NO_NOT_RECEIVED" %}</button>
                <button class="btn btn-secondary" onclick="closeModal()">{% trans "WEBAPP_CANCEL" %}</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Debug logging
        let debugInfo = [];
        
        function addDebugInfo(key, value) {
            debugInfo.push({key: key, value: value, time: new Date().toLocaleTimeString()});
            updateDebugPanel();
        }

        function updateDebugPanel() {
            const panel = document.getElementById('debugContent');
            if (!panel) return;
            
            let html = '';
            debugInfo.forEach(item => {
                const valueStr = typeof item.value === 'object' ? JSON.stringify(item.value, null, 2) : String(item.value);
                html += `<div><strong>[${item.time}] ${item.key}:</strong> ${valueStr}</div>\n`;
            });
            panel.innerHTML = html;
            panel.scrollTop = panel.scrollHeight;
        }

        // –ü–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è JavaScript (–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
        let translations = {
            // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)
            'WEBAPP_LOADING': '{% trans "WEBAPP_LOADING" %}',
            'WEBAPP_NO_GIFTS': '{% trans "WEBAPP_NO_GIFTS" %}',
            'WEBAPP_NO_ORDERS': '{% trans "WEBAPP_NO_ORDERS" %}',
            'WEBAPP_POINTS': '{% trans "WEBAPP_POINTS" %}',
            'WEBAPP_CONFIRM_REQUEST': '{% trans "WEBAPP_CONFIRM_REQUEST" %}',
            'WEBAPP_REQUEST_SENT': '{% trans "WEBAPP_REQUEST_SENT" %}',
            'WEBAPP_ERROR_LOADING_USER': '{% trans "WEBAPP_ERROR_LOADING_USER" %}',
            'WEBAPP_ERROR_LOADING_GIFTS': '{% trans "WEBAPP_ERROR_LOADING_GIFTS" %}',
            'WEBAPP_ERROR_LOADING_ORDERS': '{% trans "WEBAPP_ERROR_LOADING_ORDERS" %}',
            'WEBAPP_ERROR_REQUESTING_GIFT': '{% trans "WEBAPP_ERROR_REQUESTING_GIFT" %}',
            'WEBAPP_ERROR_CONFIRMING': '{% trans "WEBAPP_ERROR_CONFIRMING" %}',
            'WEBAPP_THANKS_CONFIRMATION': '{% trans "WEBAPP_THANKS_CONFIRMATION" %}',
            'WEBAPP_COMMENT_SENT': '{% trans "WEBAPP_COMMENT_SENT" %}',
            'WEBAPP_COMMENT_REQUIRED': '{% trans "WEBAPP_COMMENT_REQUIRED" %}',
            'WEBAPP_STATUS_PENDING': '{% trans "WEBAPP_STATUS_PENDING" %}',
            'WEBAPP_STATUS_APPROVED': '{% trans "WEBAPP_STATUS_APPROVED" %}',
            'WEBAPP_STATUS_REJECTED': '{% trans "WEBAPP_STATUS_REJECTED" %}',
            'WEBAPP_STATUS_COMPLETED': '{% trans "WEBAPP_STATUS_COMPLETED" %}',
            'WEBAPP_DELIVERY_PENDING': '{% trans "WEBAPP_DELIVERY_PENDING" %}',
            'WEBAPP_DELIVERY_SENT': '{% trans "WEBAPP_DELIVERY_SENT" %}',
            'WEBAPP_DELIVERY_DELIVERED': '{% trans "WEBAPP_DELIVERY_DELIVERED" %}',
            'WEBAPP_DELIVERY_STATUS': '{% trans "WEBAPP_DELIVERY_STATUS" %}',
            'WEBAPP_REQUESTED': '{% trans "WEBAPP_REQUESTED" %}',
            'WEBAPP_YOUR_COMMENT': '{% trans "WEBAPP_YOUR_COMMENT" %}',
            'WEBAPP_CONFIRM_RECEIPT_BUTTON': '{% trans "WEBAPP_CONFIRM_RECEIPT_BUTTON" %}',
            'USER': '{% trans "USER" %}',
        };

        // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞
        async function loadTranslations(language) {
            addDebugInfo('Loading translations', `Language: ${language}`);
            try {
                const url = `${API_BASE}/translations/?lang=${language}`;
                addDebugInfo('Translations URL', url);
                
                const response = await fetch(url);
                addDebugInfo('Translations response', `Status: ${response.status}, OK: ${response.ok}`);
                
                if (response.ok) {
                    const data = await response.json();
                    addDebugInfo('Translations received', `Total keys: ${Object.keys(data).length}`);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å WEBAPP_
                    let updatedCount = 0;
                    Object.keys(data).forEach(key => {
                        if (key.startsWith('WEBAPP_') || key === 'USER') {
                            translations[key] = data[key];
                            updatedCount++;
                        }
                    });
                    addDebugInfo('Translations updated', `Updated ${updatedCount} keys`);
                    addDebugInfo('Sample translation', `WEBAPP_YOUR_POINTS = "${translations['WEBAPP_YOUR_POINTS']}"`);
                    addDebugInfo('Sample translation', `WEBAPP_AVAILABLE_GIFTS = "${translations['WEBAPP_AVAILABLE_GIFTS']}"`);
                } else {
                    const errorText = await response.text();
                    addDebugInfo('Translations error', `Status: ${response.status}, Text: ${errorText}`);
                }
            } catch (error) {
                addDebugInfo('Translations exception', error.message);
                console.error('Error loading translations:', error);
            }
        }

        function t(key, params = {}) {
            let text = translations[key] || key;
            if (Object.keys(params).length > 0) {
                for (const [k, v] of Object.entries(params)) {
                    text = text.replace(`{${k}}`, v);
                }
            }
            return text;
        }

        let currentUser = null;
        let currentRedemptionId = null;
        const API_BASE = '/api/webapp';

        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ initData
        async function initApp() {
            addDebugInfo('=== INIT APP START ===', '');
            try {
                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                addDebugInfo('tg object', typeof tg !== 'undefined' ? 'exists' : 'undefined');
                addDebugInfo('tg.initDataUnsafe', tg.initDataUnsafe ? JSON.stringify(tg.initDataUnsafe, null, 2) : 'null');
                addDebugInfo('tg.initData', tg.initData ? tg.initData.substring(0, 100) + '...' : 'null');
                
                const initData = tg.initDataUnsafe;
                let user = initData ? initData.user : null;
                
                // –ï—Å–ª–∏ user –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ initData —Å—Ç—Ä–æ–∫–∏
                if (!user && tg.initData) {
                    addDebugInfo('Trying to parse initData string', '');
                    try {
                        // –ü–∞—Ä—Å–∏–º initData (—Ñ–æ—Ä–º–∞—Ç: key=value&key2=value2)
                        const params = new URLSearchParams(tg.initData);
                        const userParam = params.get('user');
                        if (userParam) {
                            user = JSON.parse(decodeURIComponent(userParam));
                            addDebugInfo('User parsed from initData string', JSON.stringify(user, null, 2));
                        }
                    } catch (e) {
                        addDebugInfo('Error parsing initData string', e.message);
                    }
                }
                
                // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –µ—Å–ª–∏ initData –ø—É—Å—Ç–æ–π)
                const urlParams = new URLSearchParams(window.location.search);
                const testUserId = urlParams.get('telegram_id');
                if (testUserId) {
                    addDebugInfo('Using telegram_id from URL parameter', testUserId);
                    user = { id: parseInt(testUserId) };
                }
                
                // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ—Ç user, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ hash –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                if (!user || !user.id) {
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    const hashUserId = hashParams.get('telegram_id');
                    if (hashUserId) {
                        addDebugInfo('Using telegram_id from URL hash', hashUserId);
                        user = { id: parseInt(hashUserId) };
                    }
                }
                
                addDebugInfo('Final user object', user ? JSON.stringify(user, null, 2) : 'null');
                addDebugInfo('Current URL', window.location.href);
                addDebugInfo('URL params', window.location.search);
                addDebugInfo('Hash params', window.location.hash);
                
                if (!user || !user.id) {
                    addDebugInfo('ERROR', 'No user found. Web App must be opened from Telegram bot or provide telegram_id parameter.');
                    addDebugInfo('Available tg properties', Object.keys(tg).join(', '));
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    const errorMsg = 'Web App –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç –∏–∑ Telegram –±–æ—Ç–∞.\n\n' +
                                   '–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ –≤ URL: ?telegram_id=–í–ê–®_ID';
                    showError(errorMsg);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –≤–≤–æ–¥–∞ telegram_id –≤—Ä—É—á–Ω—É—é (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
                    const debugPanel = document.getElementById('debugPanel');
                    if (debugPanel) {
                        const manualInput = document.createElement('div');
                        manualInput.style.marginTop = '10px';
                        manualInput.style.padding = '10px';
                        manualInput.style.border = '1px solid #0f0';
                        manualInput.style.background = '#001100';
                        manualInput.innerHTML = `
                            <strong style="color: #0f0;">–†—É—á–Ω–æ–π –≤–≤–æ–¥ telegram_id:</strong><br>
                            <input type="number" id="manualTelegramId" placeholder="–í–≤–µ–¥–∏—Ç–µ telegram_id" style="padding: 5px; margin: 5px 0; background: #000; color: #0f0; border: 1px solid #0f0; width: 200px;">
                            <button onclick="loadWithManualId()" style="padding: 5px 10px; margin-left: 5px; background: #0f0; color: #000; border: none; cursor: pointer; font-weight: bold;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                        `;
                        debugPanel.appendChild(manualInput);
                    }
                    return;
                }

                addDebugInfo('Loading user data', `telegram_id: ${user.id}`);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userResponse = await fetch(`${API_BASE}/user/?telegram_id=${user.id}`);
                addDebugInfo('User API response', `Status: ${userResponse.status}, OK: ${userResponse.ok}`);
                
                if (!userResponse.ok) {
                    throw new Error(t('WEBAPP_ERROR_LOADING_USER'));
                }
                currentUser = await userResponse.json();
                
                addDebugInfo('User loaded', JSON.stringify(currentUser, null, 2));
                addDebugInfo('User language', currentUser.language || 'NOT SET');
                addDebugInfo('Current translations count', Object.keys(translations).length);
                addDebugInfo('Translations before load', `WEBAPP_YOUR_POINTS = "${translations['WEBAPP_YOUR_POINTS']}"`);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è —è–∑—ã–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (currentUser.language) {
                    addDebugInfo('Loading translations', `Language: ${currentUser.language}`);
                    await loadTranslations(currentUser.language);
                    addDebugInfo('Translations loaded', 'Updating page texts...');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    updatePageTexts();
                    addDebugInfo('Page texts updated', 'DONE');
                } else {
                    addDebugInfo('WARNING', 'No language in user data, using default');
                }
                
                document.getElementById('points').textContent = currentUser.points;
                document.getElementById('userName').textContent = currentUser.first_name || t('USER');
                
                addDebugInfo('Displayed points', currentUser.points);
                addDebugInfo('Displayed name', currentUser.first_name || t('USER'));
                addDebugInfo('Final translation check', `WEBAPP_YOUR_POINTS = "${translations['WEBAPP_YOUR_POINTS']}"`);
                addDebugInfo('=== INIT APP END ===', 'SUCCESS');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∞—Ä–∫–∏ –∏ –∑–∞–∫–∞–∑—ã (–æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–µ—Ä–µ–≤–æ–¥—ã —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é t())
                await loadGifts();
                await loadRedemptions();
                
                addDebugInfo('=== INIT APP END ===', 'SUCCESS');
            } catch (error) {
                addDebugInfo('ERROR', error.message);
                addDebugInfo('ERROR STACK', error.stack);
                console.error('Error initializing app:', error);
                showError(t('WEBAPP_ERROR', {error: error.message}));
            }
        }

        async function loadGifts() {
            try {
                const response = await fetch(`${API_BASE}/gifts/`);
                if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–∞—Ä–∫–∏');
                
                const gifts = await response.json();
                const container = document.getElementById('giftsContainer');
                
                if (gifts.length === 0) {
                    container.innerHTML = `<div class="loading">${t('WEBAPP_NO_GIFTS')}</div>`;
                    return;
                }

                container.innerHTML = gifts.map(gift => {
                    const canAfford = currentUser.points >= gift.points_cost;
                    return `
                        <div class="gift-card ${canAfford ? 'available' : 'unavailable'}" 
                             onclick="${canAfford ? `requestGift(${gift.id})` : ''}">
                            <img src="${gift.image}" alt="${gift.name}" class="gift-image" onerror="this.style.display='none'">
                            <div class="gift-name">${gift.name}</div>
                            <div class="gift-cost">${gift.points_cost} ${t('WEBAPP_POINTS')}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading gifts:', error);
                document.getElementById('giftsContainer').innerHTML = 
                    `<div class="error">${t('WEBAPP_ERROR_LOADING_GIFTS')}</div>`;
            }
        }

        async function loadRedemptions() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${API_BASE}/redemptions/?telegram_id=${currentUser.telegram_id}`);
                if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã');
                
                const redemptions = await response.json();
                const container = document.getElementById('redemptionsContainer');
                
                if (redemptions.length === 0) {
                    container.innerHTML = `<div class="loading">${t('WEBAPP_NO_ORDERS')}</div>`;
                    return;
                }

                container.innerHTML = redemptions.map(redemption => {
                    const statusClass = `status-${redemption.status}`;
                    const deliveryStatusClass = `status-${redemption.delivery_status}`;
                    
                    let deliveryInfo = '';
                    let confirmSection = '';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –µ—Å–ª–∏ –∑–∞–∫–∞–∑ –æ–¥–æ–±—Ä–µ–Ω
                    if (redemption.status === 'approved' || redemption.delivery_status !== 'pending') {
                        deliveryInfo = `
                            <div class="delivery-info">
                                <div class="delivery-status">
                                    ${t('WEBAPP_DELIVERY_STATUS')} <span class="status-badge ${deliveryStatusClass}">
                                        ${getDeliveryStatusText(redemption.delivery_status)}
                                    </span>
                                </div>
                            </div>
                        `;
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –µ—Å–ª–∏ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –∏ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
                    if (redemption.delivery_status === 'delivered' && !redemption.user_confirmed) {
                        confirmSection = `
                            <div class="confirm-buttons">
                                <button class="btn btn-success" onclick="openConfirmModal(${redemption.id})">
                                    ${t('WEBAPP_CONFIRM_RECEIPT_BUTTON')}
                                </button>
                            </div>
                        `;
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (redemption.user_comment) {
                        deliveryInfo += `
                            <div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 8px; font-size: 12px;">
                                <strong>${t('WEBAPP_YOUR_COMMENT')}</strong> ${redemption.user_comment}
                            </div>
                        `;
                    }

                    return `
                        <div class="redemption-item">
                            <div class="redemption-header">
                                <div class="redemption-gift-name">${redemption.gift.name}</div>
                                <span class="status-badge ${statusClass}">${getStatusText(redemption.status)}</span>
                            </div>
                            <div style="font-size: 14px; color: var(--tg-theme-hint-color, #999999);">
                                ${t('WEBAPP_REQUESTED')} ${new Date(redemption.requested_at).toLocaleDateString()}
                            </div>
                            ${deliveryInfo}
                            ${confirmSection}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading redemptions:', error);
                document.getElementById('redemptionsContainer').innerHTML = 
                    '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
            }
        }

        async function requestGift(giftId) {
            if (!currentUser) return;
            
            if (!confirm(t('WEBAPP_CONFIRM_REQUEST'))) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/request-gift/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: currentUser.telegram_id,
                        gift_id: giftId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–¥–∞—Ä–∫–∞');
                }

                const redemption = await response.json();
                tg.showAlert(t('WEBAPP_REQUEST_SENT'));
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                await initApp();
            } catch (error) {
                console.error('Error requesting gift:', error);
                tg.showAlert(t('WEBAPP_ERROR', {error: error.message}));
            }
        }

        function openConfirmModal(redemptionId) {
            currentRedemptionId = redemptionId;
            document.getElementById('confirmModal').classList.add('active');
            document.getElementById('commentInput').value = '';
        }

        function closeModal() {
            document.getElementById('confirmModal').classList.remove('active');
            currentRedemptionId = null;
        }

        async function confirmDelivery(confirmed) {
            if (!currentRedemptionId) return;

            const comment = document.getElementById('commentInput').value;
            
            // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª, —Ç—Ä–µ–±—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            if (!confirmed && !comment.trim()) {
                tg.showAlert(t('WEBAPP_COMMENT_REQUIRED'));
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/confirm-delivery/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        redemption_id: currentRedemptionId,
                        confirmed: confirmed,
                        comment: comment
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏');
                }

                closeModal();
                
                if (confirmed) {
                    tg.showAlert(t('WEBAPP_THANKS_CONFIRMATION'));
                } else {
                    tg.showAlert(t('WEBAPP_COMMENT_SENT'));
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑—ã
                await loadRedemptions();
            } catch (error) {
                console.error('Error confirming delivery:', error);
                tg.showAlert(t('WEBAPP_ERROR', {error: error.message}));
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'WEBAPP_STATUS_PENDING',
                'approved': 'WEBAPP_STATUS_APPROVED',
                'rejected': 'WEBAPP_STATUS_REJECTED',
                'completed': 'WEBAPP_STATUS_COMPLETED'
            };
            return t(statusMap[status] || status);
        }

        function getDeliveryStatusText(status) {
            const statusMap = {
                'pending': 'WEBAPP_DELIVERY_PENDING',
                'sent': 'WEBAPP_DELIVERY_SENT',
                'delivered': 'WEBAPP_DELIVERY_DELIVERED'
            };
            return t(statusMap[status] || status);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function updatePageTexts() {
            addDebugInfo('=== UPDATE PAGE TEXTS START ===', '');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ–∫—Ü–∏–π
            const sectionTitles = document.querySelectorAll('.section-title');
            if (sectionTitles.length >= 1) {
                const oldText = sectionTitles[0].textContent;
                const newText = t('WEBAPP_AVAILABLE_GIFTS');
                addDebugInfo('Section title 1', `"${oldText}" -> "${newText}"`);
                sectionTitles[0].textContent = newText;
            }
            if (sectionTitles.length >= 2) {
                const oldText = sectionTitles[1].textContent;
                const newText = t('WEBAPP_MY_ORDERS');
                addDebugInfo('Section title 2', `"${oldText}" -> "${newText}"`);
                sectionTitles[1].textContent = newText;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ header
            const headerTitle = document.querySelector('.header > div:first-child');
            if (headerTitle) {
                const oldText = headerTitle.textContent;
                const newText = t('WEBAPP_YOUR_POINTS');
                addDebugInfo('Header title', `"${oldText}" -> "${newText}"`);
                headerTitle.textContent = newText;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modalTitle = document.querySelector('.modal-title');
            if (modalTitle) {
                const oldText = modalTitle.textContent;
                const newText = t('WEBAPP_CONFIRM_RECEIPT');
                addDebugInfo('Modal title', `"${oldText}" -> "${newText}"`);
                modalTitle.textContent = newText;
            }
            
            const modalQuestion = document.querySelector('.modal-content p');
            if (modalQuestion) {
                const oldText = modalQuestion.textContent;
                const newText = t('WEBAPP_DID_YOU_RECEIVE');
                addDebugInfo('Modal question', `"${oldText}" -> "${newText}"`);
                modalQuestion.textContent = newText;
            }
            
            const commentPlaceholder = document.getElementById('commentInput');
            if (commentPlaceholder) {
                const oldText = commentPlaceholder.placeholder;
                const newText = t('WEBAPP_COMMENT_PLACEHOLDER');
                addDebugInfo('Comment placeholder', `"${oldText}" -> "${newText}"`);
                commentPlaceholder.placeholder = newText;
            }
            
            const yesButton = document.querySelector('.btn-success[onclick*="confirmDelivery(true)"]');
            if (yesButton) {
                yesButton.textContent = t('WEBAPP_YES_RECEIVED');
            }
            
            const noButton = document.querySelector('.btn-danger[onclick*="confirmDelivery(false)"]');
            if (noButton) {
                noButton.textContent = t('WEBAPP_NO_NOT_RECEIVED');
            }
            
            const cancelButton = document.querySelector('.btn-secondary[onclick="closeModal()"]');
            if (cancelButton) {
                cancelButton.textContent = t('WEBAPP_CANCEL');
            }
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Ä—É—á–Ω—ã–º –≤–≤–æ–¥–æ–º telegram_id
        function loadWithManualId() {
            const manualId = document.getElementById('manualTelegramId');
            if (manualId && manualId.value) {
                const telegramId = parseInt(manualId.value);
                if (telegramId) {
                    addDebugInfo('Manual load', `Loading with telegram_id: ${telegramId}`);
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
                    const url = new URL(window.location.href);
                    url.searchParams.set('telegram_id', telegramId);
                    window.location.href = url.toString();
                } else {
                    addDebugInfo('ERROR', 'Invalid telegram_id');
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        initApp();
    </script>
</body>
</html>

