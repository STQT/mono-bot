{% load webapp_i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="{{ user_language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% trans "WEBAPP_MY_GIFTS" %}</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'webapp/css/styles.css' %}">
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105967279', 'ym');

        ym(105967279, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/105967279" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
    <script>
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–±—Ö–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è ngrok
        (function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è ngrok
            if (document.body && document.body.id === 'ngrok') {
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É "Visit Site" –∏ –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –Ω–µ—ë
                setTimeout(function() {
                    var visitButton = document.querySelector('button[data-testid="visit-site-button"]') ||
                                     document.querySelector('a[href*="ngrok-skip-browser-warning"]') ||
                                     document.querySelector('button:contains("Visit Site")') ||
                                     document.querySelector('a:contains("Visit Site")');
                    if (visitButton) {
                        visitButton.click();
                    } else {
                        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—ã—Ç–∞–µ–º—Å—è –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
                        var currentUrl = window.location.href;
                        if (currentUrl.indexOf('ngrok-skip-browser-warning') === -1) {
                            var separator = currentUrl.indexOf('?') === -1 ? '?' : '&';
                            window.location.href = currentUrl + separator + 'ngrok-skip-browser-warning=true';
                        }
                    }
                }, 100);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            if (typeof fetch !== 'undefined') {
                const originalFetch = window.fetch;
                window.fetch = function(...args) {
                    if (args[1]) {
                        args[1].headers = args[1].headers || {};
                        args[1].headers['ngrok-skip-browser-warning'] = 'true';
                    }
                    return originalFetch.apply(this, args);
                };
            }
        })();
    </script>
</head>
<body>
    <div class="main-container">
        <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div class="user-header">
            <div class="user-header-card">
                <!-- Skeleton loader –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è -->
                <div class="skeleton-loader skeleton-user" id="skeletonUser" style="display: flex !important; align-items: center; gap: 0.75rem; flex: 1; visibility: visible !important; opacity: 1 !important;">
                    <div class="skeleton-avatar"></div>
                    <div class="skeleton-text-group" style="flex: 1;">
                        <div class="skeleton-text skeleton-text-name"></div>
                        <div class="skeleton-text skeleton-text-id"></div>
                    </div>
                </div>
                <div class="user-info" id="userInfo" onclick="showProfile()" style="cursor: pointer; display: none;">
                    <div class="user-avatar-wrapper">
                        <div class="user-avatar" id="userAvatar">üë§</div>
                    </div>
                    <div class="user-details">
                        <div class="user-name">
                            <span id="userName">{% trans "USER" %}</span>
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <g clip-path="url(#clip0_110_61)">
                                <path d="M8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8C2 11.3137 4.68629 14 8 14Z" stroke="#40C4AA" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M6 7.99999L7.33333 9.33332L10 6.66666" stroke="#40C4AA" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </g>
                                <defs>
                                <clipPath id="clip0_110_61">
                                <rect width="16" height="16" fill="white"/>
                                </clipPath>
                                </defs>
                                </svg>                                
                        </div>
                        <div class="user-id" id="userId">ID: -</div>
                    </div>
                </div>
                <!-- Skeleton loader –¥–ª—è –±–∞–ª–ª–æ–≤ -->
                <div class="skeleton-loader skeleton-points" id="skeletonPoints" style="display: block !important; visibility: visible !important; opacity: 1 !important;"></div>
                <div class="points-badge" id="pointsBadge" style="display: none;">
                    <div class="points-value" id="points">0</div>
                    <div class="points-label">{% trans "WEBAPP_TOTAL_POINTS" %}</div>
                </div>
            </div>
        </div>

        <div id="errorContainer"></div>

        <!-- –ë–∞–Ω–Ω–µ—Ä —Å –∫–∞—Ä—É—Å–µ–ª—å—é -->
        <div class="banner-section" id="bannerSection" style="display: block;">
            <!-- Skeleton loader –¥–ª—è –±–∞–Ω–Ω–µ—Ä–∞ -->
            <div class="banner-card skeleton-banner" id="skeletonBanner" style="display: block;">
                <div class="skeleton-banner-content">
                    <div class="skeleton-text skeleton-banner-title"></div>
                </div>
                <div class="skeleton-banner-date"></div>
            </div>
            <div class="banner-card" id="bannerCard" onclick="handleBannerClick()" style="cursor: pointer; display: none;">
                <img src="" alt="" class="banner-image" id="bannerImage" style="display: none;" onerror="this.style.display='none'">
                <div class="banner-content">
                    <div class="banner-text">
                        <div class="banner-title" id="bannerTitle"></div>
                    </div>
                </div>
                <div class="banner-date-btn">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_11_3740)">
                        <path d="M12 3.33334H3.99996C3.26358 3.33334 2.66663 3.9303 2.66663 4.66668V12.6667C2.66663 13.4031 3.26358 14 3.99996 14H12C12.7363 14 13.3333 13.4031 13.3333 12.6667V4.66668C13.3333 3.9303 12.7363 3.33334 12 3.33334Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M10.6666 2V4.66667" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M5.33337 2V4.66667" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2.66663 7.33334H13.3333" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M6.66671 10H5.33337V11.3333H6.66671V10Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_11_3740">
                        <rect width="16" height="16" fill="white"/>
                        </clipPath>
                        </defs>
                        </svg>
                        
                    <span id="bannerDate"></span>
                </div>
            </div>
            <div class="banner-nav banner-nav-left" id="bannerNavLeft" onclick="event.stopPropagation(); prevBanner()" style="display: none;">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.5 15L7.5 10L12.5 5" stroke="#2064AE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="banner-nav banner-nav-right" id="bannerNavRight" onclick="event.stopPropagation(); nextBanner()" style="display: none;">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7.5 15L12.5 10L7.5 5" stroke="#2064AE" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="carousel-dots" id="carouselDots"></div>
        </div>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ QR –∫–æ–¥–∞ -->
        <div class="qr-input-section">
            <div class="qr-input-wrapper" id="qrInputWrapper">
                <input type="text" class="qr-input" id="qrInput" placeholder="EXXXXXX" maxlength="9">
                <button class="register-btn" onclick="registerQRCode()">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_110_763)">
                        <path d="M2.66666 4.66669V4.00002C2.66666 3.6464 2.80713 3.30726 3.05718 3.05721C3.30723 2.80716 3.64637 2.66669 3.99999 2.66669H5.33332" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2.66666 11.3333V12C2.66666 12.3536 2.80713 12.6927 3.05718 12.9428C3.30723 13.1928 3.64637 13.3333 3.99999 13.3333H5.33332" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M10.6667 2.66669H12C12.3536 2.66669 12.6928 2.80716 12.9428 3.05721C13.1929 3.30726 13.3334 3.6464 13.3334 4.00002V4.66669" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M10.6667 13.3333H12C12.3536 13.3333 12.6928 13.1928 12.9428 12.9428C13.1929 12.6927 13.3334 12.3536 13.3334 12V11.3333" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M4.00001 7.33331H3.33334V8.66665H4.00001V7.33331Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M6.66666 7.33331V8.66665" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M10 7.33331H9.33334V8.66665H10V7.33331Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12.6667 7.33331V8.66665" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </g>
                        <defs>
                        <clipPath id="clip0_110_763">
                        <rect width="16" height="16" fill="white"/>
                        </clipPath>
                        </defs>
                        </svg>                        
                    <span class="register-text">{% trans "WEBAPP_REGISTER" %}</span>
                </button>
            </div>
            <div class="qr-error" id="qrError" style="display: none;"></div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–¥–∞—Ä–∫–æ–≤ -->
        <div class="gifts-card" style="position: relative;">
            <!-- Skeleton loader –¥–ª—è –ø–æ–¥–∞—Ä–∫–æ–≤ -->
            <div class="skeleton-gifts" id="skeletonGifts" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
                <div class="skeleton-gifts-image"></div>
                <div class="skeleton-text skeleton-gifts-text"></div>
                <div class="skeleton-text skeleton-gifts-btn"></div>
            </div>
            <div class="gifts-content" id="giftsContent" style="display: none;">
                <div class="gifts-image-wrapper">
                    <img src="{% static 'images/gift-box.png' %}" alt="Gift" class="gifts-main-image" id="giftsMainImage" onerror="this.style.display='none'">
                </div>
                <div class="gifts-text">{% trans "WEBAPP_PARTNER_TEXT" %}</div>
            </div>
            <button class="view-gifts-btn" id="viewGiftsBtn" onclick="showGifts()" style="display: none;">
                <span class="view-gifts-text">{% trans "WEBAPP_VIEW_GIFTS" %}</span>
                <span class="gifts-count-badge">
                    <span class="gifts-count" id="giftsCount">0</span>
                </span>
            </button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
        <div class="orders-section" id="ordersSection" style="display: none;">
            <!-- <h3 class="orders-title">{% trans "WEBAPP_MY_ORDERS" %}</h3> -->
            <div class="orders-list" id="ordersList">
                <!-- –ó–∞–∫–∞–∑—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç -->
        <div class="info-text">
            <p>{% trans "WEBAPP_INFO_TEXT" %}</p>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–≤—è–∑–∏ —Å –∞–¥–º–∏–Ω–æ–º -->
        <button class="contact-admin-btn" onclick="contactAdmin()">
            <span class="contact-icon">üéß</span>
            <span>{% trans "WEBAPP_CONTACT_ADMIN" %}</span>
        </button>

        <!-- –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ -->
        <div class="privacy-link">
            <a href="#" onclick="showPrivacy(); return false;">{% trans "WEBAPP_PRIVACY_POLICY" %}</a>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù: –°–ø–∏—Å–æ–∫ –ø–æ–¥–∞—Ä–∫–æ–≤ -->
    <div class="screen" id="giftsListScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('home')">‚Äπ</button>
            <h2 class="screen-title">{% trans "WEBAPP_GIFTS_TITLE" %}</h2>
        </div>
        <div class="gifts-list-container" id="giftsListContainer">
            <div class="loading">{% trans "WEBAPP_LOADING_GIFTS" %}</div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù: –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–∞—Ä–∫–∞ -->
    <div class="screen" id="giftDetailScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('giftsList')">‚Äπ</button>
            <h2 class="screen-title" id="giftDetailTitle">{% trans "WEBAPP_GIFT_NAME" %}</h2>
            <span class="gift-badge" id="giftDetailBadge" style="display: none;">20</span>
        </div>
        <div class="gift-detail-container" id="giftDetailContainer">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù: –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (–æ–∂–∏–¥–∞–Ω–∏–µ) -->
    <div class="screen" id="redemptionDetailScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('home')">‚Äπ</button>
            <h2 class="screen-title" id="redemptionDetailTitle">{% trans "WEBAPP_GIFT_NAME" %}</h2>
        </div>
        <div class="redemption-detail-container" id="redemptionDetailContainer">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù: –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞ -->
    <div class="screen" id="successScreen" style="display: none;">
        <div class="success-container">
            <div class="success-icon">
                <img src="{% static 'images/success.png' %}" alt="Success" />
            </div>
            <h2 class="success-title">{% trans "WEBAPP_SUCCESS_TITLE" %}</h2>
            <p class="success-message">{% trans "WEBAPP_SUCCESS_MESSAGE" %}</p>
            <button class="btn btn-primary" onclick="showScreen('home')">{% trans "WEBAPP_TO_HOME" %}</button>
            <button class="btn btn-secondary" onclick="contactAdmin()">{% trans "WEBAPP_CONTACT_ADMIN" %}</button>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù: –ü—Ä–æ—Ñ–∏–ª—å -->
    <div class="screen" id="profileScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('home')">‚Äπ</button>
            <h2 class="screen-title">{% trans "WEBAPP_PROFILE" %}</h2>
        </div>
        <div class="profile-container">
            <div class="profile-menu">
                <div class="menu-item" onclick="showLanguageModal()">
                    <span class="menu-icon">üåê</span>
                    <span class="menu-text">{% trans "WEBAPP_INTERFACE_LANGUAGE" %}</span>
                    <span class="menu-value" id="currentLanguage">O'zbekcha</span>
                    <span class="menu-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="showScreen('profileGifts')">
                    <span class="menu-icon">üéÅ</span>
                    <span class="menu-text">{% trans "WEBAPP_GIFTS" %}</span>
                    <span class="menu-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="showScreen('qrHistory')">
                    <span class="menu-icon">üïê</span>
                    <span class="menu-text">{% trans "WEBAPP_QR_HISTORY" %}</span>
                    <span class="menu-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="showPrivacy()">
                    <span class="menu-icon">üîí</span>
                    <span class="menu-text">{% trans "WEBAPP_PRIVACY_POLICY" %}</span>
                    <span class="menu-arrow">‚Ä∫</span>
                </div>
            </div>
            <button class="contact-admin-btn" onclick="contactAdmin()">
                <span class="contact-icon">üéß</span>
                <span>{% trans "WEBAPP_CONTACT_ADMIN" %}</span>
            </button>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù: –ü–æ–¥–∞—Ä–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª–µ -->
    <div class="screen" id="profileGiftsScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('profile')">‚Äπ</button>
            <h2 class="screen-title">{% trans "WEBAPP_GIFTS" %}</h2>
        </div>
        <div class="profile-gifts-container" id="profileGiftsContainer">
            <div class="loading">{% trans "WEBAPP_LOADING_ORDERS" %}</div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù: –ò—Å—Ç–æ—Ä–∏—è QR-–∫–æ–¥–æ–≤ -->
    <div class="screen" id="qrHistoryScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('profile')">‚Äπ</button>
            <h2 class="screen-title">{% trans "WEBAPP_QR_HISTORY" %}</h2>
        </div>
        <div class="qr-history-container" id="qrHistoryContainer">
            <div class="loading">{% trans "WEBAPP_LOADING_QR_HISTORY" %}</div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù: –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ü–∏–∏ -->
    <div class="screen" id="promotionDetailScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen('home')">‚Äπ</button>
            <h2 class="screen-title" id="promotionDetailTitle"></h2>
        </div>
        <div class="promotion-detail-container" id="promotionDetailContainer">
            <div class="loading">{% trans "WEBAPP_LOADING" %}</div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù: –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ -->
    <div class="screen" id="privacyScreen" style="display: none;">
        <div class="screen-header">
            <button class="back-btn" onclick="showScreen(getPreviousScreen())">‚Äπ</button>
            <h2 class="screen-title">{% trans "WEBAPP_PRIVACY_POLICY" %}</h2>
        </div>
        <div class="privacy-container" id="privacyContainer">
            <div class="loading">{% trans "WEBAPP_LOADING" %}</div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê: –í—ã–±–æ—Ä —è–∑—ã–∫–∞ -->
    <div class="modal" id="languageModal">
        <div class="modal-content language-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">{% trans "WEBAPP_INTERFACE_LANGUAGE" %}</h3>
                <button class="modal-close" onclick="closeLanguageModal()">‚úï</button>
            </div>
            <div class="language-options">
                <div class="language-option" onclick="changeLanguage('uz_latin')">
                    <span class="language-flag">üá∫üáø</span>
                    <span class="language-name">{% trans "WEBAPP_UZBEK" %}</span>
                    <span class="language-check" id="checkUzLatin" style="display: none;">‚úì</span>
                </div>
                <div class="language-option" onclick="changeLanguage('ru')">
                    <span class="language-flag">üá∑üá∫</span>
                    <span class="language-name">{% trans "WEBAPP_RUSSIAN" %}</span>
                    <span class="language-check" id="checkRu" style="display: none;">‚úì</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-title">{% trans "WEBAPP_CONFIRM_RECEIPT" %}</div>
            <p>{% trans "WEBAPP_DID_YOU_RECEIVE" %}</p>
            <textarea class="comment-input" id="commentInput" placeholder="{% trans 'WEBAPP_COMMENT_PLACEHOLDER' %}"></textarea>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="confirmDelivery(true)">{% trans "WEBAPP_YES_RECEIVED" %}</button>
                <button class="btn btn-danger" onclick="confirmDelivery(false)">{% trans "WEBAPP_NO_NOT_RECEIVED" %}</button>
                <button class="btn btn-secondary" onclick="closeModal()">{% trans "WEBAPP_CANCEL" %}</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –ü–µ—Ä–µ–≤–æ–¥—ã –¥–ª—è JavaScript
        let translations = {
            'WEBAPP_LOADING': '{% trans "WEBAPP_LOADING" %}',
            'WEBAPP_NO_GIFTS': '{% trans "WEBAPP_NO_GIFTS" %}',
            'WEBAPP_POINTS': '{% trans "WEBAPP_POINTS" %}',
            'WEBAPP_CONFIRM_REQUEST': '{% trans "WEBAPP_CONFIRM_REQUEST" %}',
            'WEBAPP_REQUEST_SENT': '{% trans "WEBAPP_REQUEST_SENT" %}',
            'WEBAPP_ERROR_LOADING_USER': '{% trans "WEBAPP_ERROR_LOADING_USER" %}',
            'WEBAPP_ERROR_LOADING_GIFTS': '{% trans "WEBAPP_ERROR_LOADING_GIFTS" %}',
            'WEBAPP_ERROR_REQUESTING_GIFT': '{% trans "WEBAPP_ERROR_REQUESTING_GIFT" %}',
            'WEBAPP_ERROR_CONFIRMING': '{% trans "WEBAPP_ERROR_CONFIRMING" %}',
            'WEBAPP_THANKS_CONFIRMATION': '{% trans "WEBAPP_THANKS_CONFIRMATION" %}',
            'WEBAPP_COMMENT_SENT': '{% trans "WEBAPP_COMMENT_SENT" %}',
            'WEBAPP_COMMENT_REQUIRED': '{% trans "WEBAPP_COMMENT_REQUIRED" %}',
            'USER': '{% trans "USER" %}',
            'WEBAPP_QR_ERROR': '{% trans "WEBAPP_QR_ERROR" %}',
            'WEBAPP_QR_PLACEHOLDER': '{% trans "WEBAPP_QR_PLACEHOLDER" %}',
            'WEBAPP_GIFTS_TITLE': '{% trans "WEBAPP_GIFTS_TITLE" %}',
            'WEBAPP_GIFT_NAME': '{% trans "WEBAPP_GIFT_NAME" %}',
            'WEBAPP_GET_GIFT': '{% trans "WEBAPP_GET_GIFT" %}',
            'WEBAPP_NOT_ENOUGH_POINTS': '{% trans "WEBAPP_NOT_ENOUGH_POINTS" %}',
            'WEBAPP_WAITING_PROCESS': '{% trans "WEBAPP_WAITING_PROCESS" %}',
            'WEBAPP_SUCCESS_TITLE': '{% trans "WEBAPP_SUCCESS_TITLE" %}',
            'WEBAPP_SUCCESS_MESSAGE': '{% trans "WEBAPP_SUCCESS_MESSAGE" %}',
            'WEBAPP_TO_HOME': '{% trans "WEBAPP_TO_HOME" %}',
            'WEBAPP_PROFILE': '{% trans "WEBAPP_PROFILE" %}',
            'WEBAPP_INTERFACE_LANGUAGE': '{% trans "WEBAPP_INTERFACE_LANGUAGE" %}',
            'WEBAPP_GIFTS': '{% trans "WEBAPP_GIFTS" %}',
            'WEBAPP_QR_HISTORY': '{% trans "WEBAPP_QR_HISTORY" %}',
            'WEBAPP_UZBEK': '{% trans "WEBAPP_UZBEK" %}',
            'WEBAPP_RUSSIAN': '{% trans "WEBAPP_RUSSIAN" %}',
            'WEBAPP_CLOSE': '{% trans "WEBAPP_CLOSE" %}',
            'WEBAPP_BALL': '{% trans "WEBAPP_BALL" %}',
            'WEBAPP_LOADING_QR_HISTORY': '{% trans "WEBAPP_LOADING_QR_HISTORY" %}',
            'WEBAPP_NO_QR_HISTORY': '{% trans "WEBAPP_NO_QR_HISTORY" %}',
            'WEBAPP_LOADING_GIFTS': '{% trans "WEBAPP_LOADING_GIFTS" %}',
            'WEBAPP_LOADING_ORDERS': '{% trans "WEBAPP_LOADING_ORDERS" %}',
            'WEBAPP_NO_ORDERS': '{% trans "WEBAPP_NO_ORDERS" %}',
            'WEBAPP_STATUS_PENDING': '{% trans "WEBAPP_STATUS_PENDING" %}',
            'WEBAPP_STATUS_APPROVED': '{% trans "WEBAPP_STATUS_APPROVED" %}',
            'WEBAPP_STATUS_SENT': '{% trans "WEBAPP_STATUS_SENT" %}',
            'WEBAPP_STATUS_REJECTED': '{% trans "WEBAPP_STATUS_REJECTED" %}',
            'WEBAPP_STATUS_COMPLETED': '{% trans "WEBAPP_STATUS_COMPLETED" %}',
            'WEBAPP_TOTAL_POINTS': '{% trans "WEBAPP_TOTAL_POINTS" %}',
            'WEBAPP_REGISTER': '{% trans "WEBAPP_REGISTER" %}',
            'WEBAPP_PARTNER_TEXT': '{% trans "WEBAPP_PARTNER_TEXT" %}',
            'WEBAPP_VIEW_GIFTS': '{% trans "WEBAPP_VIEW_GIFTS" %}',
            'WEBAPP_INFO_TEXT': '{% trans "WEBAPP_INFO_TEXT" %}',
            'WEBAPP_CONTACT_ADMIN': '{% trans "WEBAPP_CONTACT_ADMIN" %}',
            'WEBAPP_PRIVACY_POLICY': '{% trans "WEBAPP_PRIVACY_POLICY" %}',
            'WEBAPP_CONFIRM_RECEIPT': '{% trans "WEBAPP_CONFIRM_RECEIPT" %}',
            'WEBAPP_DID_YOU_RECEIVE': '{% trans "WEBAPP_DID_YOU_RECEIVE" %}',
            'WEBAPP_COMMENT_PLACEHOLDER': '{% trans "WEBAPP_COMMENT_PLACEHOLDER" %}',
            'WEBAPP_YES_RECEIVED': '{% trans "WEBAPP_YES_RECEIVED" %}',
            'WEBAPP_NO_NOT_RECEIVED': '{% trans "WEBAPP_NO_NOT_RECEIVED" %}',
            'WEBAPP_CANCEL': '{% trans "WEBAPP_CANCEL" %}',
            'WEBAPP_UPDATED': '{% trans "WEBAPP_UPDATED" %}',
            'WEBAPP_QR_MAX_ATTEMPTS': '{% trans "WEBAPP_QR_MAX_ATTEMPTS" %}',
            'WEBAPP_PRIVACY_PDF_DESCRIPTION': '{% trans "WEBAPP_PRIVACY_PDF_DESCRIPTION" %}',
            'WEBAPP_OPEN_PDF': '{% trans "WEBAPP_OPEN_PDF" %}',
        };

        async function loadTranslations(language) {
            try {
                const url = `${API_BASE}/translations/?lang=${language}`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    Object.keys(data).forEach(key => {
                        if (key.startsWith('WEBAPP_') || key === 'USER') {
                            translations[key] = data[key];
                        }
                    });
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤
                    updatePageTexts();
                }
            } catch (error) {
                console.error('Error loading translations:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ —Ç—ã—Å—è—á (–ø—Ä–æ–±–µ–ª–∞–º–∏)
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }
        
        function t(key, params = {}) {
            let text = translations[key] || key;
            if (Object.keys(params).length > 0) {
                for (const [k, v] of Object.entries(params)) {
                    text = text.replace(`{${k}}`, v);
                }
            }
            return text;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è SVG-–∏–∫–æ–Ω–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
        function getStatusIcon(status) {
            const icons = {
                'pending': `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
                    <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>`,
                'approved': '‚úÖ',
                'sent': 'üì¶',
                'rejected': '‚ùå',
                'completed': '‚úîÔ∏è'
            };
            return icons[status] || icons['pending'];
        }

        let currentUser = null;
        let currentRedemptionId = null;
        let promotions = [];
        let currentBannerIndex = 0;
        let currentDotColor = '#2064AE'; // –¶–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–∏
        let previousScreen = null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫—Ä–∞–Ω –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –ø–æ–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
        const API_BASE = '/api/webapp';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–≥–æ —Ü–≤–µ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function getDominantColor(imageUrl, callback) {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º: –±–µ—Ä–µ–º —Å—Ä–µ–¥–Ω–∏–π —Ü–≤–µ—Ç –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const centerX = Math.floor(canvas.width / 2);
                    const centerY = Math.floor(canvas.height / 2);
                    const sampleSize = 50; // –†–∞–∑–º–µ—Ä –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                    const startX = Math.max(0, centerX - sampleSize);
                    const startY = Math.max(0, centerY - sampleSize);
                    const endX = Math.min(canvas.width, centerX + sampleSize);
                    const endY = Math.min(canvas.height, centerY + sampleSize);
                    
                    let r = 0, g = 0, b = 0, count = 0;
                    
                    for (let y = startY; y < endY; y += 5) {
                        for (let x = startX; x < endX; x += 5) {
                            const index = (y * canvas.width + x) * 4;
                            r += data[index];
                            g += data[index + 1];
                            b += data[index + 2];
                            count++;
                        }
                    }
                    
                    if (count > 0) {
                        r = Math.floor(r / count);
                        g = Math.floor(g / count);
                        b = Math.floor(b / count);
                        
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ hex
                        const hexColor = '#' + [r, g, b].map(x => {
                            const hex = x.toString(16);
                            return hex.length === 1 ? '0' + hex : hex;
                        }).join('');
                        
                        callback(hexColor);
                    } else {
                        callback('#2064AE'); // –¶–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    }
                } catch (error) {
                    console.error('Error extracting color:', error);
                    callback('#2064AE'); // –¶–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
                }
            };
            
            img.onerror = function() {
                callback('#2064AE'); // –¶–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏
            };
            
            img.src = imageUrl;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è placeholder QR –∫–æ–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function updateQRPlaceholder() {
            const qrInput = document.getElementById('qrInput');
            if (!qrInput) return;
            
            if (currentUser && currentUser.user_type) {
                // –ï—Å–ª–∏ –ü—Ä–æ–¥–∞–≤–µ—Ü (seller) -> DXXXXXX
                // –ï—Å–ª–∏ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å/–≠–ª–µ–∫—Ç—Ä–∏–∫ (electrician) -> EXXXXXX
                if (currentUser.user_type === 'seller') {
                    qrInput.placeholder = 'DXXXXXX';
                } else if (currentUser.user_type === 'electrician') {
                    qrInput.placeholder = 'EXXXXXX';
                } else {
                    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é EXXXXXX
                    qrInput.placeholder = 'EXXXXXX';
                }
            } else {
                // –ï—Å–ª–∏ —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º EXXXXXX –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                qrInput.placeholder = 'EXXXXXX';
            }
        }

        async function initApp() {
            try {
                const initData = tg.initDataUnsafe;
                let user = initData ? initData.user : null;
                
                if (!user && tg.initData) {
                    try {
                        const params = new URLSearchParams(tg.initData);
                        const userParam = params.get('user');
                        if (userParam) {
                            user = JSON.parse(decodeURIComponent(userParam));
                        }
                    } catch (e) {
                        console.error('Error parsing initData:', e);
                    }
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                const testUserId = urlParams.get('telegram_id');
                if (testUserId && !user) {
                    user = { id: parseInt(testUserId) };
                }
                
                if (!user || !user.id) {
                    showError('Web App –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç –∏–∑ Telegram –±–æ—Ç–∞.');
                    return;
                }

                const userResponse = await fetch(`${API_BASE}/user/?telegram_id=${user.id}`);
                if (!userResponse.ok) {
                    throw new Error(t('WEBAPP_ERROR_LOADING_USER'));
                }
                currentUser = await userResponse.json();
                
                // –°–∫—Ä—ã–≤–∞–µ–º skeleton loader –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const skeletonUser = document.getElementById('skeletonUser');
                const skeletonPoints = document.getElementById('skeletonPoints');
                const userInfo = document.getElementById('userInfo');
                const pointsBadge = document.getElementById('pointsBadge');
                
                if (skeletonUser) skeletonUser.style.display = 'none';
                if (skeletonPoints) skeletonPoints.style.display = 'none';
                if (userInfo) userInfo.style.display = 'flex';
                if (pointsBadge) pointsBadge.style.display = 'flex';
                
                document.getElementById('points').textContent = formatNumber(currentUser.points);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                if (currentUser.first_name || currentUser.telegram_id) {
                    document.getElementById('userName').textContent = currentUser.first_name || t('USER');
                    document.getElementById('userId').textContent = `ID: ${currentUser.telegram_id}`;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                if (user.photo_url) {
                    const avatar = document.getElementById('userAvatar');
                    avatar.style.backgroundImage = `url(${user.photo_url})`;
                    avatar.style.backgroundSize = 'cover';
                    avatar.style.backgroundPosition = 'center';
                    avatar.textContent = '';
                    avatar.style.color = 'transparent';
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º placeholder –¥–ª—è QR –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                updateQRPlaceholder();
                
                if (currentUser.language) {
                    await loadTranslations(currentUser.language);
                }
                
                await loadPromotions();
                await loadGiftsCount();
                await loadProductStatus();
            } catch (error) {
                console.error('Error initializing app:', error);
                showError(t('WEBAPP_ERROR_LOADING_USER'));
            }
        }

        async function loadGiftsCount() {
            try {
                // –ü–µ—Ä–µ–¥–∞–µ–º telegram_id –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —è–∑—ã–∫–µ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω)
                const giftsUrl = currentUser && currentUser.telegram_id 
                    ? `${API_BASE}/gifts/?telegram_id=${currentUser.telegram_id}`
                    : `${API_BASE}/gifts/`;
                const response = await fetch(giftsUrl);
                if (response.ok) {
                    const gifts = await response.json();
                    const countElement = document.getElementById('giftsCount');
                    if (countElement) {
                        countElement.textContent = gifts.length;
                    }
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º skeleton loader –¥–ª—è –ø–æ–¥–∞—Ä–∫–æ–≤ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const skeletonGifts = document.getElementById('skeletonGifts');
                    const giftsContent = document.getElementById('giftsContent');
                    const viewGiftsBtn = document.getElementById('viewGiftsBtn');
                    
                    if (skeletonGifts) skeletonGifts.style.display = 'none';
                    if (giftsContent) giftsContent.style.display = 'flex';
                    if (viewGiftsBtn) viewGiftsBtn.style.display = 'flex';
                    
                    // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç–∏—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ gift-box.png
                    const giftImage = document.getElementById('giftsMainImage');
                    if (giftImage) {
                        giftImage.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading gifts count:', error);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ç–æ–∂–µ —Å–∫—Ä—ã–≤–∞–µ–º skeleton
                const skeletonGifts = document.getElementById('skeletonGifts');
                const giftsContent = document.getElementById('giftsContent');
                const viewGiftsBtn = document.getElementById('viewGiftsBtn');
                
                if (skeletonGifts) skeletonGifts.style.display = 'none';
                if (giftsContent) giftsContent.style.display = 'flex';
                if (viewGiftsBtn) viewGiftsBtn.style.display = 'flex';
            }
        }

        async function loadProductStatus() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${API_BASE}/redemptions/?telegram_id=${currentUser.telegram_id}`);
                if (response.ok) {
                    const redemptions = await response.json();
                    const ordersSection = document.getElementById('ordersSection');
                    const ordersList = document.getElementById('ordersList');
                    
                    if (redemptions && redemptions.length > 0) {
                        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–∫–∞–∑—ã: —Å–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ (pending, approved, sent), –ø–æ—Ç–æ–º completed, –ø–æ—Ç–æ–º rejected
                        const sortedRedemptions = redemptions.sort((a, b) => {
                            const statusOrder = {
                                'pending': 1,
                                'approved': 2,
                                'sent': 3,
                                'completed': 4,
                                'rejected': 5
                            };
                            const orderA = statusOrder[a.status] || 999;
                            const orderB = statusOrder[b.status] || 999;
                            if (orderA !== orderB) {
                                return orderA - orderB;
                            }
                            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                            return new Date(b.requested_at) - new Date(a.requested_at);
                        });
                        
                        ordersList.innerHTML = '';
                        sortedRedemptions.forEach(redemption => {
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
                            let statusText = t('WEBAPP_STATUS_PENDING');
                            let statusClass = 'waiting';
                            if (redemption.status === 'approved') {
                                statusText = t('WEBAPP_STATUS_APPROVED');
                                statusClass = 'approved';
                            } else if (redemption.status === 'sent') {
                                statusText = t('WEBAPP_STATUS_SENT');
                                statusClass = 'sent';
                            } else if (redemption.status === 'rejected') {
                                statusText = t('WEBAPP_STATUS_REJECTED');
                                statusClass = 'rejected';
                            } else if (redemption.status === 'completed') {
                                statusText = t('WEBAPP_STATUS_COMPLETED');
                                statusClass = 'completed';
                            }
                            
                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
                            const date = new Date(redemption.requested_at);
                            const dateStr = date.toLocaleDateString('ru-RU', { 
                                year: 'numeric', 
                                month: '2-digit', 
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            const orderCard = document.createElement('div');
                            orderCard.className = 'order-card';
                            orderCard.onclick = () => showRedemptionDetail(redemption.id);
                            
                            let imageUrl = '/static/images/gift-box.png';
                            if (redemption.gift && redemption.gift.image) {
                                imageUrl = redemption.gift.image.startsWith('http') 
                                    ? redemption.gift.image 
                                    : redemption.gift.image;
                            }
                            
                            let confirmButtonHtml = '';
                            if (!redemption.user_confirmed && redemption.status === 'completed') {
                                confirmButtonHtml = `
                                    <button class="btn btn-success btn-small" onclick="event.stopPropagation(); openConfirmModal(${redemption.id});">
                                        ${t('WEBAPP_YES_RECEIVED')}
                                    </button>
                                `;
                            }
                            
                            orderCard.innerHTML = `
                                <div class="order-image">
                                    <img src="${imageUrl}" alt="" onerror="this.src='/static/images/gift-box.png'">
                                </div>
                                <div class="order-info">
                                    <div class="order-name">${redemption.gift ? redemption.gift.name : 'N/A'}</div>
                                    <div class="order-status ${statusClass}">${statusText}</div>
                                    <div class="order-date">${dateStr}</div>
                                    ${confirmButtonHtml ? `<div style="margin-top: 0.5rem;">${confirmButtonHtml}</div>` : ''}
                                </div>
                                <div class="order-arrow">‚Ä∫</div>
                            `;
                            
                            ordersList.appendChild(orderCard);
                        });
                        
                        ordersSection.style.display = 'block';
                    } else {
                        ordersSection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading product status:', error);
            }
        }

        async function registerQRCode() {
            const qrCode = document.getElementById('qrInput').value.trim();
            const errorDiv = document.getElementById('qrError');
            const inputWrapper = document.getElementById('qrInputWrapper');
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –æ—à–∏–±–∫—É
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            inputWrapper.classList.remove('error');
            
            if (!qrCode) {
                showQRError(t('WEBAPP_QR_ERROR'));
                return;
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ QR –∫–æ–¥–∞ (EXXXXXX –∏–ª–∏ DXXXXXX)
            const qrPattern = /^[ED]\w{6,}$/;
            if (!qrPattern.test(qrCode)) {
                showQRError(t('WEBAPP_QR_ERROR'));
                return;
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ –∫–æ–¥–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (currentUser && currentUser.user_type) {
                const codePrefix = qrCode.substring(0, 1);
                const expectedPrefix = currentUser.user_type === 'seller' ? 'D' : 'E';
                
                if (codePrefix !== expectedPrefix) {
                    showQRError(t('WEBAPP_QR_WRONG_TYPE'));
                    return;
                }
            }
            
            if (!currentUser || !currentUser.telegram_id) {
                showQRError(t('WEBAPP_ERROR_LOADING_USER'));
                return;
            }
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é QR –∫–æ–¥–∞
                const response = await fetch(`${API_BASE}/register-qr/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegram_id: currentUser.telegram_id,
                        qr_code: qrCode
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –ø–æ–ø—ã—Ç–æ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if (data.error_code === 'max_attempts') {
                        showQRError(data.error || t('WEBAPP_QR_MAX_ATTEMPTS'));
                    } else if (data.error_code === 'wrong_type') {
                        showQRError(data.error || t('WEBAPP_QR_WRONG_TYPE'));
                    } else {
                        showQRError(data.error || t('WEBAPP_QR_ERROR'));
                    }
                    return;
                }
                
                // –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    currentUser.points = data.total_points;
                    document.getElementById('points').textContent = formatNumber(data.total_points);
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    const qrInput = document.getElementById('qrInput');
                    qrInput.value = '';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏
                    const registerBtn = document.querySelector('.register-btn');
                    if (registerBtn) {
                        registerBtn.classList.remove('active');
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    tg.showAlert(data.message || t('WEBAPP_SUCCESS_MESSAGE'));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é QR –∫–æ–¥–æ–≤, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏—Å—Ç–æ—Ä–∏–∏
                    if (document.getElementById('qrHistoryScreen').style.display !== 'none') {
                        await loadQRHistory();
                    }
                } else {
                    showQRError(data.error || t('WEBAPP_QR_ERROR'));
                }
            } catch (error) {
                console.error('Error registering QR code:', error);
                showQRError(t('WEBAPP_QR_ERROR'));
            }
        }

        function showQRError(message) {
            const errorDiv = document.getElementById('qrError');
            const inputWrapper = document.getElementById('qrInputWrapper');
            
            // –û–±–µ—Ä—Ç—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤ span –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞
            errorDiv.innerHTML = '<span class="qr-error-text">' + message + '</span>';
            errorDiv.style.display = 'flex';
            inputWrapper.classList.add('error');
        }

        function showGifts() {
            showScreen('giftsList');
            loadGiftsList();
        }

        // –°–∏—Å—Ç–µ–º–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
        async function showScreen(screenName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
            document.querySelectorAll('.screen').forEach(screen => {
                screen.style.display = 'none';
            });
            document.querySelector('.main-container').style.display = screenName === 'home' ? 'flex' : 'none';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω
            if (screenName === 'home') {
                document.querySelector('.main-container').style.display = 'flex';
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                await loadProductStatus();
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–∞–ª–ª—ã)
                if (currentUser && currentUser.telegram_id) {
                    try {
                        const userResponse = await fetch(`${API_BASE}/user/?telegram_id=${currentUser.telegram_id}`);
                        if (userResponse.ok) {
                            const userData = await userResponse.json();
                            currentUser.points = userData.points;
                            document.getElementById('points').textContent = formatNumber(currentUser.points);
                        }
                    } catch (error) {
                        console.error('Error updating user data:', error);
                    }
                }
            } else {
                const screen = document.getElementById(`${screenName}Screen`);
                if (screen) {
                    screen.style.display = 'block';
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤
                    if (screenName === 'profileGifts') {
                        await loadProfileGifts();
                    } else if (screenName === 'qrHistory') {
                        await loadQRHistory();
                    } else if (screenName === 'privacy') {
                        await loadPrivacyPolicy();
                    }
                }
            }
        }

        async function loadGiftsList() {
            const container = document.getElementById('giftsListContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">' + t('WEBAPP_LOADING_GIFTS') + '</div>';
            
            try {
                if (!currentUser || !currentUser.telegram_id) {
                    throw new Error('User not loaded');
                }
                
                // –ü–µ—Ä–µ–¥–∞–µ–º telegram_id –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —è–∑—ã–∫–µ
                const giftsUrl = `${API_BASE}/gifts/?telegram_id=${currentUser.telegram_id}`;
                const response = await fetch(giftsUrl);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const gifts = await response.json();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º redemptions –æ—Ç–¥–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–∏—Ö
                let redemptions = [];
                try {
                    const redemptionsResponse = await fetch(`${API_BASE}/redemptions/?telegram_id=${currentUser.telegram_id}`);
                    if (redemptionsResponse.ok) {
                        redemptions = await redemptionsResponse.json();
                    }
                } catch (e) {
                    console.warn('Failed to load redemptions:', e);
                }
                
                if (!gifts || gifts.length === 0) {
                    container.innerHTML = '<div class="empty-state">' + t('WEBAPP_NO_GIFTS') + '</div>';
                    return;
                }
                
                container.innerHTML = '';
                gifts.forEach(gift => {
                    const redemption = redemptions.find(r => r.gift && r.gift.id === gift.id);
                    const userPoints = currentUser.points || 0;
                    const hasEnoughPoints = userPoints >= gift.points_cost;
                    const progress = Math.min((userPoints / gift.points_cost) * 100, 100);
                    
                    const giftCard = document.createElement('div');
                    giftCard.className = 'gift-card';
                    giftCard.onclick = () => showGiftDetail(gift.id);
                    
                    let statusHtml = '';
                    if (redemption) {
                        if (redemption.status === 'pending') {
                            statusHtml = `<div class="gift-status waiting">${t('WEBAPP_STATUS_PENDING')}</div>`;
                        } else if (redemption.status === 'approved') {
                            statusHtml = `<div class="gift-status approved">${t('WEBAPP_STATUS_APPROVED')}</div>`;
                        } else if (redemption.status === 'sent') {
                            statusHtml = `<div class="gift-status sent">${t('WEBAPP_STATUS_SENT')}</div>`;
                        } else if (redemption.status === 'rejected') {
                            statusHtml = `<div class="gift-status rejected">${t('WEBAPP_STATUS_REJECTED')}</div>`;
                        } else if (redemption.status === 'completed') {
                            statusHtml = `<div class="gift-status completed">${t('WEBAPP_STATUS_COMPLETED')}</div>`;
                        }
                    } else if (hasEnoughPoints) {
                        statusHtml = `<button class="gift-get-btn" onclick="event.stopPropagation(); requestGift(${gift.id})">${t('WEBAPP_GET_GIFT')}</button>`;
                    } else {
                        statusHtml = `<div class="gift-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <div class="progress-text">${formatNumber(userPoints)} / ${formatNumber(gift.points_cost)} ${t('WEBAPP_BALL')}</div>
                        </div>`;
                    }
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    let imageUrl = '/static/images/gift-box.png';
                    if (gift.image) {
                        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–ª–Ω—ã–π URL, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
                        if (gift.image.startsWith('http://') || gift.image.startsWith('https://')) {
                            imageUrl = gift.image;
                        } else {
                            // –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å, –¥–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL
                            imageUrl = gift.image.startsWith('/') ? gift.image : `/${gift.image}`;
                        }
                    }
                    
                    giftCard.innerHTML = `
                        <div class="gift-card-image-wrapper">
                            <img src="${imageUrl}" alt="${gift.name || 'Gift'}" class="gift-card-image" onerror="this.src='/static/images/gift-box.png'">
                        </div>
                        ${statusHtml}
                        <div class="gift-card-name">${gift.name || t('WEBAPP_GIFT_NAME')}</div>
                        <div class="gift-card-points">${formatNumber(gift.points_cost || 0)} ${t('WEBAPP_BALL')}</div>
                    `;
                    container.appendChild(giftCard);
                });
            } catch (error) {
                console.error('Error loading gifts:', error);
                container.innerHTML = '<div class="error">' + t('WEBAPP_ERROR_LOADING_GIFTS') + '</div>';
            }
        }

        async function showGiftDetail(giftId) {
            showScreen('giftDetail');
            const container = document.getElementById('giftDetailContainer');
            container.innerHTML = '<div class="loading">' + t('WEBAPP_LOADING') + '</div>';
            
            try {
                // –ü–µ—Ä–µ–¥–∞–µ–º telegram_id –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —è–∑—ã–∫–µ
                const giftsUrl = currentUser && currentUser.telegram_id 
                    ? `${API_BASE}/gifts/?telegram_id=${currentUser.telegram_id}`
                    : `${API_BASE}/gifts/`;
                const giftsResponse = await fetch(giftsUrl);
                const gifts = await giftsResponse.json();
                const gift = gifts.find(g => g.id === giftId);
                
                if (!gift) throw new Error('Gift not found');
                
                const userPoints = currentUser.points || 0;
                const hasEnoughPoints = userPoints >= gift.points_cost;
                const progress = Math.min((userPoints / gift.points_cost) * 100, 100);
                
                document.getElementById('giftDetailTitle').textContent = gift.name;
                
                // –í—Å–µ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–∫–∞–∑, –µ—Å–ª–∏ –µ—Å—Ç—å –±–∞–ª–ª—ã, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤
                let actionHtml = '';
                if (hasEnoughPoints) {
                    actionHtml = `<button class="btn btn-primary gift-detail-btn" onclick="requestGift(${gift.id})">
                        <span class="btn-icon">üîÑ</span>
                        ${t('WEBAPP_GET_GIFT')}
                    </button>`;
                } else {
                    actionHtml = `
                        <div class="gift-progress-detail">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <div class="progress-text">${formatNumber(userPoints)} / ${formatNumber(gift.points_cost)} ${t('WEBAPP_BALL')}</div>
                        </div>
                        <div class="not-enough-points">${t('WEBAPP_NOT_ENOUGH_POINTS')}</div>
                    `;
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                let detailImageUrl = '/static/images/gift-box.png';
                if (gift.image) {
                    if (gift.image.startsWith('http://') || gift.image.startsWith('https://')) {
                        detailImageUrl = gift.image;
                    } else {
                        detailImageUrl = gift.image.startsWith('/') ? gift.image : `/${gift.image}`;
                    }
                }
                
                container.innerHTML = `
                    <div class="gift-detail-image">
                        <img src="${detailImageUrl}" alt="${gift.name || 'Gift'}" onerror="this.src='/static/images/gift-box.png'">
                    </div>
                    <div class="gift-detail-info">
                        <div class="gift-detail-name">${gift.name || t('WEBAPP_GIFT_NAME')}</div>
                        <div class="gift-detail-points">${formatNumber(gift.points_cost || 0)} ${t('WEBAPP_BALL')}</div>
                        ${gift.description ? `<div class="gift-detail-description">${gift.description}</div>` : ''}
                    </div>
                    ${actionHtml}
                `;
            } catch (error) {
                container.innerHTML = '<div class="error">' + t('WEBAPP_ERROR_LOADING_GIFTS') + '</div>';
            }
        }

        async function showRedemptionDetail(redemptionId) {
            showScreen('redemptionDetail');
            const container = document.getElementById('redemptionDetailContainer');
            container.innerHTML = '<div class="loading">' + t('WEBAPP_LOADING') + '</div>';
            
            try {
                if (!currentUser || !currentUser.telegram_id) {
                    throw new Error('User not loaded');
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ redemption
                const response = await fetch(`${API_BASE}/redemptions/?telegram_id=${currentUser.telegram_id}`);
                if (!response.ok) {
                    throw new Error('Failed to load redemption');
                }
                
                const redemptions = await response.json();
                const redemption = redemptions.find(r => r.id === redemptionId);
                
                if (!redemption) {
                    throw new Error('Redemption not found');
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                document.getElementById('redemptionDetailTitle').textContent = redemption.gift ? redemption.gift.name : t('WEBAPP_GIFT_NAME');
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ –∏ –∏–∫–æ–Ω–∫—É
                let statusText = t('WEBAPP_STATUS_PENDING');
                let statusClass = 'waiting';
                let statusIcon = getStatusIcon('pending');
                if (redemption.status === 'approved') {
                    statusText = t('WEBAPP_STATUS_APPROVED');
                    statusClass = 'approved';
                    statusIcon = getStatusIcon('approved');
                } else if (redemption.status === 'sent') {
                    statusText = t('WEBAPP_STATUS_SENT');
                    statusClass = 'sent';
                    statusIcon = getStatusIcon('sent');
                } else if (redemption.status === 'rejected') {
                    statusText = t('WEBAPP_STATUS_REJECTED');
                    statusClass = 'rejected';
                    statusIcon = getStatusIcon('rejected');
                } else if (redemption.status === 'completed') {
                    statusText = t('WEBAPP_STATUS_COMPLETED');
                    statusClass = 'completed';
                    statusIcon = getStatusIcon('completed');
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                let imageUrl = '/static/images/gift-box.png';
                if (redemption.gift && redemption.gift.image) {
                    if (redemption.gift.image.startsWith('http://') || redemption.gift.image.startsWith('https://')) {
                        imageUrl = redemption.gift.image;
                    } else if (redemption.gift.image.startsWith('/')) {
                        imageUrl = redemption.gift.image;
                    } else {
                        imageUrl = '/' + redemption.gift.image;
                    }
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–∞—Ä–∫–∞
                const giftPoints = redemption.gift ? redemption.gift.points_cost : 0;
                
                // HTML –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–∂–∏–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ (–¥–∏–∑–∞–π–Ω –ø–æ –≤—Ç–æ—Ä–æ–º—É —Ä–∏—Å—É–Ω–∫—É)
                container.innerHTML = `
                    <div class="redemption-detail-content">
                        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                        <div class="redemption-user-card" onclick="showProfile()" style="cursor: pointer;">
                            <div class="redemption-user-avatar">
                                <div class="redemption-avatar-icon">üë§</div>
                            </div>
                            <div class="redemption-user-info">
                                <div class="redemption-user-name">
                                    ${currentUser.first_name || t('USER')}
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_110_61)">
                                        <path d="M8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8C2 11.3137 4.68629 14 8 14Z" stroke="#40C4AA" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M6 7.99999L7.33333 9.33332L10 6.66666" stroke="#40C4AA" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </g>
                                        <defs>
                                        <clipPath id="clip0_110_61">
                                        <rect width="16" height="16" fill="white"/>
                                        </clipPath>
                                        </defs>
                                    </svg>
                                </div>
                                <div class="redemption-user-id">ID: ${currentUser.telegram_id}</div>
                            </div>
                            <div class="points-badge" onclick="event.stopPropagation();">
                                <div class="points-value">${formatNumber(currentUser.points || 0)}</div>
                                <div class="points-label">${t('WEBAPP_TOTAL_POINTS')}</div>
                            </div>
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏ —Å–≤—è–∑–∏ -->
                        <div class="redemption-actions">
                            <button class="redemption-status-btn ${statusClass}">
                                <span class="status-icon">${statusIcon}</span>
                                ${statusText}
                            </button>
                            <button class="redemption-contact-btn" onclick="contactAdmin()">
                                <span class="contact-icon">üéß</span>
                                ${t('WEBAPP_CONTACT_ADMIN')}
                            </button>
                        </div>
                        
                        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–¥–∞—Ä–∫–∞ -->
                        <div class="redemption-gift-card">
                            <div class="redemption-gift-image-wrapper">
                                <img src="${imageUrl}" alt="${redemption.gift ? redemption.gift.name : ''}" class="redemption-gift-img" onerror="this.onerror=null; this.src='/static/images/gift-box.png';">
                            </div>
                            <div class="redemption-gift-name">${redemption.gift ? redemption.gift.name : t('WEBAPP_GIFT_NAME')}</div>
                            <div class="redemption-gift-points">${formatNumber(giftPoints)} ${t('WEBAPP_BALL')}</div>
                        </div>
                        
                        <!-- –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ -->
                        <div class="redemption-privacy-link">
                            <a href="#" onclick="showPrivacy(); return false;">{% trans "WEBAPP_PRIVACY_POLICY" %}</a>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading redemption detail:', error);
                container.innerHTML = '<div class="error">' + (error.message || t('WEBAPP_ERROR_LOADING_ORDERS')) + '</div>';
            }
        }

        async function requestGift(giftId) {
            if (!confirm(t('WEBAPP_CONFIRM_REQUEST'))) return;
            
            try {
                const response = await fetch(`${API_BASE}/request-gift/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegram_id: currentUser.telegram_id,
                        gift_id: giftId
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || t('WEBAPP_ERROR_REQUESTING_GIFT'));
                }
                
                const redemption = await response.json();
                currentUser.points = redemption.user.points;
                document.getElementById('points').textContent = formatNumber(currentUser.points);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞
                await loadProductStatus();
                showScreen('success');
            } catch (error) {
                tg.showAlert(error.message || t('WEBAPP_ERROR_REQUESTING_GIFT'));
            }
        }

        async function loadProfileGifts() {
            const container = document.getElementById('profileGiftsContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">' + t('WEBAPP_LOADING_ORDERS') + '</div>';
            
            if (!currentUser || !currentUser.telegram_id) {
                container.innerHTML = '<div class="error">' + t('WEBAPP_ERROR_LOADING_USER') + '</div>';
                console.error('loadProfileGifts: currentUser not loaded');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/redemptions/?telegram_id=${currentUser.telegram_id}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const redemptions = await response.json();
                
                if (redemptions.length === 0) {
                    container.innerHTML = '<div class="empty-state">' + t('WEBAPP_NO_ORDERS') + '</div>';
                    return;
                }
                
                container.innerHTML = '';
                redemptions.forEach(redemption => {
                    const card = document.createElement('div');
                    card.className = 'profile-gift-card';
                    card.onclick = () => showGiftDetail(redemption.gift.id);
                    
                    let statusClass = 'pending';
                    let statusText = t('WEBAPP_STATUS_PENDING');
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
                    if (redemption.status === 'approved') {
                        statusClass = 'approved';
                        statusText = t('WEBAPP_STATUS_APPROVED');
                    } else if (redemption.status === 'sent') {
                        statusClass = 'sent';
                        statusText = t('WEBAPP_STATUS_SENT');
                    } else if (redemption.status === 'rejected') {
                        statusClass = 'rejected';
                        statusText = t('WEBAPP_STATUS_REJECTED');
                    } else if (redemption.status === 'completed') {
                        statusClass = 'completed';
                        statusText = t('WEBAPP_STATUS_COMPLETED');
                    } else {
                        // pending
                        statusClass = 'pending';
                        statusText = t('WEBAPP_STATUS_PENDING');
                    }
                    
                    const imageUrl = redemption.gift.image || '/static/images/gift-box.png';

                    let confirmButtonHtml = '';
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ 'completed' –∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–ª—É—á–µ–Ω–∏–µ
                    if (!redemption.user_confirmed && redemption.status === 'completed') {
                        confirmButtonHtml = `
                            <button class="btn btn-success btn-small" onclick="event.stopPropagation(); openConfirmModal(${redemption.id});">
                                ${t('WEBAPP_YES_RECEIVED')}
                            </button>
                        `;
                    }

                    card.innerHTML = `
                        <img src="${imageUrl}" alt="${redemption.gift.name}" class="profile-gift-image" onerror="this.src='/static/images/gift-box.png'">
                        <div class="profile-gift-info">
                            <div class="profile-gift-name">${redemption.gift.name}</div>
                            <div class="profile-gift-status ${statusClass}">${statusText}</div>
                            ${confirmButtonHtml}
                        </div>
                        <span class="profile-gift-arrow">‚Ä∫</span>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading profile gifts:', error);
                container.innerHTML = '<div class="error">' + (error.message || t('WEBAPP_ERROR_LOADING_ORDERS')) + '</div>';
            }
        }

        function openConfirmModal(redemptionId) {
            currentRedemptionId = redemptionId;
            const modal = document.getElementById('confirmModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal() {
            const modal = document.getElementById('confirmModal');
            if (modal) {
                modal.classList.remove('active');
            }
            const commentInput = document.getElementById('commentInput');
            if (commentInput) {
                commentInput.value = '';
            }
        }

        async function confirmDelivery(confirmed) {
            if (!currentRedemptionId) {
                tg.showAlert(t('WEBAPP_ERROR_CONFIRMING'));
                return;
            }

            try {
                const comment = document.getElementById('commentInput') ? document.getElementById('commentInput').value.trim() : '';

                const response = await fetch(`${API_BASE}/confirm-delivery/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        redemption_id: currentRedemptionId,
                        confirmed: confirmed,
                        comment: comment
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.error || t('WEBAPP_ERROR_CONFIRMING'));
                }

                await response.json();

                closeModal();
                tg.showAlert(t('WEBAPP_THANKS_CONFIRMATION'));

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–¥—É–∫—Ç–∞
                if (document.getElementById('profileGiftsScreen').style.display !== 'none') {
                    await loadProfileGifts();
                }
                await loadProductStatus();
            } catch (error) {
                console.error('Error confirming delivery:', error);
                tg.showAlert(error.message || t('WEBAPP_ERROR_CONFIRMING'));
            }
        }

        async function loadQRHistory() {
            const container = document.getElementById('qrHistoryContainer');
            container.innerHTML = '<div class="loading">' + t('WEBAPP_LOADING_QR_HISTORY') + '</div>';
            
            try {
                const response = await fetch(`${API_BASE}/qr-history/?telegram_id=${currentUser.telegram_id}`);
                if (!response.ok) throw new Error();
                
                const history = await response.json();
                
                if (history.length === 0) {
                    container.innerHTML = '<div class="empty-state">' + t('WEBAPP_NO_QR_HISTORY') + '</div>';
                    return;
                }
                
                container.innerHTML = '';
                history.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'qr-history-card';
                    card.innerHTML = `
                        <div class="qr-history-icon">üì±</div>
                        <div class="qr-history-info">
                            <div class="qr-history-code">#${item.code}</div>
                            <div class="qr-history-date">${item.scanned_at}</div>
                        </div>
                        <div class="qr-history-points">
                            <div class="qr-history-points-value">${item.points}</div>
                            <div class="qr-history-points-label">${t('WEBAPP_BALL')}</div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                container.innerHTML = '<div class="error">' + t('WEBAPP_ERROR_LOADING_ORDERS') + '</div>';
            }
        }

        function showLanguageModal() {
            document.getElementById('languageModal').classList.add('active');
            updateLanguageChecks();
        }

        function closeLanguageModal() {
            document.getElementById('languageModal').classList.remove('active');
        }

        function updateLanguageChecks() {
            document.getElementById('checkUzLatin').style.display = currentUser.language === 'uz_latin' ? 'block' : 'none';
            document.getElementById('checkRu').style.display = currentUser.language === 'ru' ? 'block' : 'none';
        }

        function getLanguageName(language) {
            if (language === 'uz_latin') return t('WEBAPP_UZBEK');
            if (language === 'ru') return t('WEBAPP_RUSSIAN');
            return t('WEBAPP_UZBEK');
        }

        async function changeLanguage(language) {
            if (!currentUser || !currentUser.telegram_id) {
                tg.showAlert(t('WEBAPP_ERROR_LOADING_USER'));
                return;
            }
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–∑—ã–∫–∞
                const response = await fetch(`${API_BASE}/update-language/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegram_id: currentUser.telegram_id,
                        language: language
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update language');
                }
                
                const data = await response.json();
                if (data.success) {
                    currentUser.language = language;
                    await loadTranslations(language);
                    updateLanguageChecks();
                    closeLanguageModal();
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –º–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è
                    document.getElementById('currentLanguage').textContent = getLanguageName(language);
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                    updatePageTexts();
                }
            } catch (error) {
                console.error('Error updating language:', error);
                tg.showAlert(t('WEBAPP_ERROR_LOADING_USER'));
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç–∫—Ä–∞–Ω–∞–º–∏
        function showProfile() {
            showScreen('profile');
        }

        function showQRHistory() {
            showScreen('qrHistory');
            loadQRHistory();
        }

        function showProfileGifts() {
            showScreen('profileGifts');
            // loadProfileGifts() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ showScreen()
        }

        function contactAdmin() {
            const botUsername = '{{ TELEGRAM_BOT_ADMIN_USERNAME }}';
            if (botUsername) {
                tg.openTelegramLink(`https://t.me/${botUsername}`);
            } else {
                tg.showAlert('Bot username not configured');
            }
        }

        function openPrivacyPDF(pdfUrl) {
            if (tg && tg.openLink) {
                tg.openLink(pdfUrl);
            } else {
                window.open(pdfUrl, '_blank');
            }
        }

        async function showPrivacy() {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏
            const screens = [
                'redemptionDetail', 'profileGifts', 'qrHistory', 'giftDetail', 
                'giftsList', 'profile', 'promotionDetail', 'home'
            ];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
            for (const screen of screens) {
                const screenElement = document.getElementById(`${screen}Screen`);
                if (screenElement && screenElement.style.display !== 'none') {
                    previousScreen = screen;
                    break;
                }
            }
            
            // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω —ç–∫—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º main-container
            if (!previousScreen && document.querySelector('.main-container').style.display !== 'none') {
                previousScreen = 'home';
            }
            
            // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º 'profile' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (!previousScreen) {
                previousScreen = 'profile';
            }
            
            showScreen('privacy');
            // loadPrivacyPolicy() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ showScreen()
        }
        
        function getPreviousScreen() {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω –∏–ª–∏ 'profile' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            return previousScreen || 'profile';
        }

        async function loadPrivacyPolicy() {
            const container = document.getElementById('privacyContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">' + t('WEBAPP_LOADING') + '</div>';
            
            if (!currentUser || !currentUser.language) {
                container.innerHTML = '<div class="error">' + t('WEBAPP_ERROR_LOADING_USER') + '</div>';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/privacy-policy/?lang=${currentUser.language}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                let contentHtml = '';
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å PDF —Ñ–∞–π–ª, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è
                // –í Telegram Web App PDF –Ω–µ–ª—å–∑—è –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                if (data.pdf_url) {
                    contentHtml = `
                        <div class="privacy-content">
                            <div class="privacy-pdf-wrapper">
                                <div class="privacy-pdf-icon">üìÑ</div>
                                <h3 class="privacy-pdf-title">${t('WEBAPP_PRIVACY_POLICY') || '–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏'}</h3>
                                <p class="privacy-pdf-text">${t('WEBAPP_PRIVACY_PDF_DESCRIPTION') || '–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ.'}</p>
                                <button class="btn btn-primary privacy-pdf-open-btn" onclick="openPrivacyPDF('${data.pdf_url}')">
                                    ${t('WEBAPP_OPEN_PDF') || '–û—Ç–∫—Ä—ã—Ç—å PDF'}
                                </button>
                            </div>
                            ${data.updated_at ? `<div class="privacy-updated">${t('WEBAPP_UPDATED')}: ${data.updated_at}</div>` : ''}
                        </div>
                    `;
                    container.innerHTML = contentHtml;
                } else {
                    contentHtml = '<div class="empty-state">' + (t('WEBAPP_NO_CONTENT') || '–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω') + '</div>';
                    container.innerHTML = contentHtml;
                }
            } catch (error) {
                console.error('Error loading privacy policy:', error);
                container.innerHTML = '<div class="error">' + (error.message || t('WEBAPP_ERROR_LOADING_USER')) + '</div>';
            }
        }

        function handleBannerClick() {
            if (promotions.length > 0 && promotions[currentBannerIndex]) {
                showPromotionDetail(promotions[currentBannerIndex].id);
            }
        }

        async function showPromotionDetail(promotionId) {
            showScreen('promotionDetail');
            const container = document.getElementById('promotionDetailContainer');
            container.innerHTML = '<div class="loading">' + t('WEBAPP_LOADING') + '</div>';
            
            try {
                const response = await fetch(`${API_BASE}/promotions/${promotionId}/`);
                if (!response.ok) throw new Error();
                
                const promotion = await response.json();
                
                document.getElementById('promotionDetailTitle').textContent = promotion.title || '';
                
                container.innerHTML = `
                    <div class="promotion-detail-image">
                        <img src="${promotion.image || ''}" alt="${promotion.title || 'Promotion'}" onerror="this.style.display='none'">
                    </div>
                    <div class="promotion-detail-info">
                        <div class="promotion-detail-date">
                            <svg class="calendar-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="2.67" y="3.33" width="10.67" height="10.67" stroke="currentColor" stroke-width="1.5" fill="none" rx="1"/>
                                <line x1="5.33" y1="1.67" x2="5.33" y2="5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <line x1="10.67" y1="1.67" x2="10.67" y2="5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <line x1="2.67" y1="7.33" x2="13.33" y2="7.33" stroke="currentColor" stroke-width="1.5"/>
                                <line x1="5.33" y1="10" x2="5.33" y2="13.33" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <line x1="8" y1="10" x2="8" y2="13.33" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                <line x1="10.67" y1="10" x2="10.67" y2="13.33" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            </svg>
                            <span>${promotion.date || ''}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = '<div class="error">' + t('WEBAPP_ERROR_LOADING_USER') + '</div>';
            }
        }

        async function loadPromotions() {
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º skeleton loader —Å—Ä–∞–∑—É
                const bannerSection = document.getElementById('bannerSection');
                const skeletonBanner = document.getElementById('skeletonBanner');
                if (bannerSection) bannerSection.style.display = 'block';
                if (skeletonBanner) skeletonBanner.style.display = 'block';
                
                const response = await fetch(`${API_BASE}/promotions/`);
                if (response.ok) {
                    promotions = await response.json();
                    const bannerCard = document.getElementById('bannerCard');
                    const bannerNavLeft = document.getElementById('bannerNavLeft');
                    const bannerNavRight = document.getElementById('bannerNavRight');
                    
                    if (promotions && promotions.length > 0) {
                        currentBannerIndex = 0;
                        if (bannerSection) {
                            bannerSection.style.display = 'block';
                        }
                        // –°–∫—Ä—ã–≤–∞–µ–º skeleton –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä
                        if (skeletonBanner) {
                            skeletonBanner.style.display = 'none';
                            skeletonBanner.style.visibility = 'hidden';
                            skeletonBanner.style.opacity = '0';
                        }
                        if (bannerCard) {
                            bannerCard.style.display = 'block';
                        }
                        
                        updateBanner();
                        updateCarouselDots();
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ü–∏–π, —Å–∫—Ä—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä –∏ skeleton
                        if (bannerSection) {
                            bannerSection.style.display = 'none';
                        }
                        if (skeletonBanner) {
                            skeletonBanner.style.display = 'none';
                            skeletonBanner.style.visibility = 'hidden';
                            skeletonBanner.style.opacity = '0';
                        }
                    }
                } else {
                    // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ —É—Å–ø–µ—à–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏
                    const bannerSection = document.getElementById('bannerSection');
                    const skeletonBanner = document.getElementById('skeletonBanner');
                    const bannerCard = document.getElementById('bannerCard');
                    const bannerNavLeft = document.getElementById('bannerNavLeft');
                    const bannerNavRight = document.getElementById('bannerNavRight');
                    
                    if (bannerSection && promotions && promotions.length > 0) {
                        bannerSection.style.display = 'block';
                        if (skeletonBanner) {
                            skeletonBanner.style.display = 'none';
                            skeletonBanner.style.visibility = 'hidden';
                            skeletonBanner.style.opacity = '0';
                        }
                        if (bannerCard) {
                            bannerCard.style.display = 'block';
                        }
                        updateBanner();
                    } else if (bannerSection) {
                        bannerSection.style.display = 'none';
                        if (skeletonBanner) {
                            skeletonBanner.style.display = 'none';
                            skeletonBanner.style.visibility = 'hidden';
                            skeletonBanner.style.opacity = '0';
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading promotions:', error);
                // –ù–µ —Å–∫—Ä—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏
                const bannerSection = document.getElementById('bannerSection');
                const skeletonBanner = document.getElementById('skeletonBanner');
                const bannerCard = document.getElementById('bannerCard');
                
                if (bannerSection && promotions && promotions.length > 0) {
                    bannerSection.style.display = 'block';
                    if (skeletonBanner) {
                        skeletonBanner.style.display = 'none';
                        skeletonBanner.style.visibility = 'hidden';
                        skeletonBanner.style.opacity = '0';
                    }
                    if (bannerCard) {
                        bannerCard.style.display = 'block';
                    }
                    updateBanner();
                } else if (bannerSection) {
                    bannerSection.style.display = 'none';
                    if (skeletonBanner) {
                        skeletonBanner.style.display = 'none';
                        skeletonBanner.style.visibility = 'hidden';
                        skeletonBanner.style.opacity = '0';
                    }
                }
            }
        }

        function updateBanner() {
            if (!promotions || promotions.length === 0) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–∞
            if (currentBannerIndex < 0 || currentBannerIndex >= promotions.length) {
                currentBannerIndex = 0;
            }
            
            const promotion = promotions[currentBannerIndex];
            if (!promotion) return;
            
            const bannerTitle = document.getElementById('bannerTitle');
            const bannerDate = document.getElementById('bannerDate');
            const bannerImage = document.getElementById('bannerImage');
            const bannerCard = document.getElementById('bannerCard');
            const bannerSection = document.getElementById('bannerSection');
            const bannerNavLeft = document.getElementById('bannerNavLeft');
            const bannerNavRight = document.getElementById('bannerNavRight');
            const skeletonBanner = document.getElementById('skeletonBanner');
            
            // –°–∫—Ä—ã–≤–∞–µ–º skeleton loader –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä
            if (skeletonBanner) {
                skeletonBanner.style.display = 'none';
                skeletonBanner.style.visibility = 'hidden';
                skeletonBanner.style.opacity = '0';
            }
            if (bannerCard) {
                bannerCard.style.display = 'block';
                bannerCard.style.visibility = 'visible';
                bannerCard.style.opacity = '1';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä –µ—Å–ª–∏ –æ–Ω —Å–∫—Ä—ã—Ç
            if (bannerSection) {
                bannerSection.style.display = 'block';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π –∞–∫—Ü–∏–∏
            if (promotions.length > 1) {
                if (bannerNavLeft) bannerNavLeft.style.display = 'flex';
                if (bannerNavRight) bannerNavRight.style.display = 'flex';
            } else {
                if (bannerNavLeft) bannerNavLeft.style.display = 'none';
                if (bannerNavRight) bannerNavRight.style.display = 'none';
            }
            
            if (bannerTitle) {
                bannerTitle.textContent = promotion.title || '';
            }
            
            if (bannerDate) {
                bannerDate.textContent = promotion.date || '';
            }
            
            if (bannerImage && promotion.image) {
                bannerImage.src = promotion.image;
                bannerImage.style.display = 'block';
                // –£–±–∏—Ä–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω –∏ padding, –∫–æ–≥–¥–∞ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                if (bannerCard) {
                    bannerCard.style.background = 'transparent';
                    bannerCard.style.padding = '0';
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —Ü–≤–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ –∞–∫—Ç–∏–≤–Ω–æ–π —Ç–æ—á–∫–µ
                getDominantColor(promotion.image, function(color) {
                    currentDotColor = color;
                    updateCarouselDots();
                });
                
                bannerImage.onerror = function() {
                    this.style.display = 'none';
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω, –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
                    if (bannerCard) {
                        bannerCard.style.background = '';
                        bannerCard.style.padding = '';
                    }
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    currentDotColor = '#2064AE';
                    updateCarouselDots();
                };
            } else if (bannerImage) {
                bannerImage.style.display = 'none';
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω, –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                if (bannerCard) {
                    bannerCard.style.background = '';
                    bannerCard.style.padding = '';
                }
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                currentDotColor = '#2064AE';
                updateCarouselDots();
            } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                currentDotColor = '#2064AE';
                updateCarouselDots();
            }
        }

        function updateCarouselDots() {
            const dotsContainer = document.getElementById('carouselDots');
            if (!dotsContainer) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–∞
            if (currentBannerIndex < 0 || currentBannerIndex >= promotions.length) {
                currentBannerIndex = 0;
            }
            
            dotsContainer.innerHTML = '';
            
            if (!promotions || promotions.length === 0) {
                dotsContainer.style.display = 'none';
                return;
            }
            
            dotsContainer.style.display = 'flex';
            
            // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–ª–∞–π–¥, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–∫–∏
            if (promotions.length === 1) {
                dotsContainer.style.display = 'none';
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ —Å–ª–∞–π–¥–æ–≤
            for (let i = 0; i < promotions.length; i++) {
                const dot = document.createElement('div');
                
                if (i === currentBannerIndex) {
                    // –ê–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    dot.className = 'dot active';
                    dot.style.background = currentDotColor;
                    dot.style.boxShadow = `0 0 0.375rem ${currentDotColor}66`; // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ–Ω–∏
                } else {
                    // –ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è —Ç–æ—á–∫–∞ - —Å–µ—Ä—ã–π —Ü–≤–µ—Ç
                    dot.className = 'dot';
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å –≤ data-–∞—Ç—Ä–∏–±—É—Ç
                dot.setAttribute('data-index', i);
                dot.onclick = (e) => {
                    e.stopPropagation();
                    const targetIndex = parseInt(e.currentTarget.getAttribute('data-index'));
                    if (targetIndex >= 0 && targetIndex < promotions.length && targetIndex !== currentBannerIndex) {
                        currentBannerIndex = targetIndex;
                        updateBanner();
                        updateCarouselDots();
                    }
                };
                
                dotsContainer.appendChild(dot);
            }
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ç–æ—á–∫–∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ wrapper –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è
            dotsContainer.style.marginLeft = 'auto';
            dotsContainer.style.marginRight = 'auto';
            dotsContainer.style.width = 'fit-content';
            dotsContainer.style.maxWidth = 'fit-content';
            dotsContainer.style.display = 'flex';
            dotsContainer.style.justifyContent = 'center';
            dotsContainer.style.alignItems = 'center';
        }

        function prevBanner() {
            if (!promotions || promotions.length === 0) return;
            currentBannerIndex = (currentBannerIndex - 1 + promotions.length) % promotions.length;
            if (currentBannerIndex < 0) currentBannerIndex = promotions.length - 1;
            if (currentBannerIndex >= promotions.length) currentBannerIndex = 0;
            updateBanner();
            updateCarouselDots();
        }

        function nextBanner() {
            if (!promotions || promotions.length === 0) return;
            currentBannerIndex = (currentBannerIndex + 1) % promotions.length;
            if (currentBannerIndex < 0) currentBannerIndex = promotions.length - 1;
            if (currentBannerIndex >= promotions.length) currentBannerIndex = 0;
            updateBanner();
            updateCarouselDots();
        }

        function updatePageTexts() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É –±–∞–ª–ª–æ–≤
            const pointsLabel = document.querySelector('.points-label');
            if (pointsLabel) {
                pointsLabel.textContent = t('WEBAPP_TOTAL_POINTS');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            const infoText = document.querySelector('.info-text p');
            if (infoText) {
                infoText.textContent = t('WEBAPP_INFO_TEXT');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Å–≤—è–∑–∏ —Å –∞–¥–º–∏–Ω–æ–º
            const contactBtns = document.querySelectorAll('.contact-admin-btn span:last-child');
            contactBtns.forEach(btn => {
                if (btn.textContent.trim() !== '') {
                    btn.textContent = t('WEBAPP_CONTACT_ADMIN');
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ QR
            const registerText = document.querySelector('.register-text');
            if (registerText) {
                registerText.textContent = t('WEBAPP_REGISTER');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º placeholder –¥–ª—è QR –≤–≤–æ–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            updateQRPlaceholder();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–∞
            const partnerText = document.querySelector('.gifts-text');
            if (partnerText) {
                partnerText.textContent = t('WEBAPP_PARTNER_TEXT');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–¥–∞—Ä–∫–æ–≤
            const viewGiftsText = document.querySelector('.view-gifts-text');
            if (viewGiftsText) {
                viewGiftsText.textContent = t('WEBAPP_VIEW_GIFTS');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
            const privacyLink = document.querySelector('.privacy-link a');
            if (privacyLink) {
                privacyLink.textContent = t('WEBAPP_PRIVACY_POLICY');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —ç–∫—Ä–∞–Ω–æ–≤
            const screenTitles = document.querySelectorAll('.screen-title');
            screenTitles.forEach(title => {
                const screenId = title.closest('.screen')?.id;
                if (screenId === 'giftsListScreen') {
                    title.textContent = t('WEBAPP_GIFTS_TITLE');
                } else if (screenId === 'profileScreen') {
                    title.textContent = t('WEBAPP_PROFILE');
                } else if (screenId === 'profileGiftsScreen') {
                    title.textContent = t('WEBAPP_GIFTS');
                } else if (screenId === 'qrHistoryScreen') {
                    title.textContent = t('WEBAPP_QR_HISTORY');
                } else if (screenId === 'privacyScreen') {
                    title.textContent = t('WEBAPP_PRIVACY_POLICY');
                } else if (screenId === 'successScreen') {
                    // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
            const languageModalTitle = document.querySelector('.language-modal-content .modal-title');
            if (languageModalTitle) {
                languageModalTitle.textContent = t('WEBAPP_INTERFACE_LANGUAGE');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —è–∑—ã–∫–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const languageOptions = document.querySelectorAll('.language-option .language-name');
            languageOptions.forEach((option, index) => {
                if (index === 0) {
                    option.textContent = t('WEBAPP_UZBEK');
                } else if (index === 1) {
                    option.textContent = t('WEBAPP_RUSSIAN');
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –≤ –º–µ–Ω—é –ø—Ä–æ—Ñ–∏–ª—è
            const menuItems = document.querySelectorAll('.menu-item .menu-text');
            menuItems.forEach((item, index) => {
                const menuItem = item.closest('.menu-item');
                if (menuItem) {
                    const icon = menuItem.querySelector('.menu-icon')?.textContent;
                    if (icon === 'üåê') {
                        item.textContent = t('WEBAPP_INTERFACE_LANGUAGE');
                    } else if (icon === 'üéÅ') {
                        item.textContent = t('WEBAPP_GIFTS');
                    } else if (icon === 'üïê') {
                        item.textContent = t('WEBAPP_QR_HISTORY');
                    } else if (icon === 'üîí') {
                        item.textContent = t('WEBAPP_PRIVACY_POLICY');
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –≤ —ç–∫—Ä–∞–Ω–µ —É—Å–ø–µ—Ö–∞
            const successTitle = document.querySelector('#successScreen .success-title');
            if (successTitle) {
                successTitle.textContent = t('WEBAPP_SUCCESS_TITLE');
            }
            
            const successMessage = document.querySelector('#successScreen .success-message');
            if (successMessage) {
                successMessage.textContent = t('WEBAPP_SUCCESS_MESSAGE');
            }
            
            const toHomeBtn = document.querySelector('#successScreen .btn-primary');
            if (toHomeBtn) {
                toHomeBtn.textContent = t('WEBAPP_TO_HOME');
            }
            
            const contactAdminBtnSuccess = document.querySelector('#successScreen .btn-secondary');
            if (contactAdminBtnSuccess) {
                contactAdminBtnSuccess.textContent = t('WEBAPP_CONTACT_ADMIN');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            const confirmModalTitle = document.querySelector('#confirmModal .modal-title');
            if (confirmModalTitle) {
                confirmModalTitle.textContent = t('WEBAPP_CONFIRM_RECEIPT');
            }
            
            const confirmModalText = document.querySelector('#confirmModal p');
            if (confirmModalText) {
                confirmModalText.textContent = t('WEBAPP_DID_YOU_RECEIVE');
            }
            
            const commentInput = document.getElementById('commentInput');
            if (commentInput) {
                commentInput.placeholder = t('WEBAPP_COMMENT_PLACEHOLDER');
            }
            
            const yesBtn = document.querySelector('#confirmModal .btn-success');
            if (yesBtn) {
                yesBtn.textContent = t('WEBAPP_YES_RECEIVED');
            }
            
            const noBtn = document.querySelector('#confirmModal .btn-danger');
            if (noBtn) {
                noBtn.textContent = t('WEBAPP_NO_NOT_RECEIVED');
            }
            
            const cancelBtn = document.querySelector('#confirmModal .btn-secondary');
            if (cancelBtn) {
                cancelBtn.textContent = t('WEBAPP_CANCEL');
            }
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —ç–∫—Ä–∞–Ω —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–æ–¥–∞—Ä–∫–æ–≤, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
            if (document.getElementById('giftsListScreen').style.display !== 'none') {
                loadGiftsList();
            }
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —ç–∫—Ä–∞–Ω —Å –∏—Å—Ç–æ—Ä–∏–µ–π QR, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
            if (document.getElementById('qrHistoryScreen').style.display !== 'none') {
                loadQRHistory();
            }
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —ç–∫—Ä–∞–Ω —Å –ø–æ–¥–∞—Ä–∫–∞–º–∏ –ø—Ä–æ—Ñ–∏–ª—è, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
            if (document.getElementById('profileGiftsScreen').style.display !== 'none') {
                loadProfileGifts();
            }
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —ç–∫—Ä–∞–Ω –¥–µ—Ç–∞–ª–µ–π –ø–æ–¥–∞—Ä–∫–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
            const giftDetailScreen = document.getElementById('giftDetailScreen');
            if (giftDetailScreen && giftDetailScreen.style.display !== 'none') {
                const giftDetailTitle = document.getElementById('giftDetailTitle');
                if (giftDetailTitle && giftDetailTitle.textContent) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø–æ–¥–∞—Ä–∫–∞ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
                    const container = document.getElementById('giftDetailContainer');
                    if (container) {
                        const giftIdMatch = container.innerHTML.match(/gift.*?id[=:](\d+)/i);
                        if (giftIdMatch) {
                            showGiftDetail(parseInt(giftIdMatch[1]));
                        }
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–¥—É–∫—Ç–∞, –µ—Å–ª–∏ –æ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
            const productStatus = document.getElementById('productStatus');
            if (productStatus && productStatus.textContent) {
                const statusText = productStatus.textContent.trim();
                if (statusText === t('WEBAPP_STATUS_PENDING') || 
                    statusText.includes('pending') || 
                    statusText.includes('–û–∂–∏–¥–∞–µ—Ç') ||
                    statusText.includes('Kutilmoqda')) {
                    productStatus.textContent = t('WEBAPP_STATUS_PENDING');
                }
            }
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª—è –∫–Ω–æ–ø–∫–∏
        document.addEventListener('DOMContentLoaded', function() {
            const qrInput = document.getElementById('qrInput');
            const registerBtn = document.querySelector('.register-btn');
            
            function updateRegisterButton() {
                if (qrInput && registerBtn) {
                    const value = qrInput.value.trim();
                    if (value.length > 0) {
                        registerBtn.classList.add('active');
                    } else {
                        registerBtn.classList.remove('active');
                    }
                }
            }
            
            function getExpectedPrefix() {
                if (currentUser && currentUser.user_type) {
                    return currentUser.user_type === 'seller' ? 'D' : 'E';
                }
                return 'E'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é E
            }
            
            if (qrInput) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                updateRegisterButton();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ - —Å—Ä–∞–∑—É –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å
                qrInput.addEventListener('keydown', function(e) {
                    // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç –≤–≤–æ–¥–∏—Ç—å —Å–∏–º–≤–æ–ª
                    if (qrInput.value.length === 0) {
                        const key = e.key;
                        // –ï—Å–ª–∏ —ç—Ç–æ –±—É–∫–≤–∞ –∏–ª–∏ —Ü–∏—Ñ—Ä–∞ (–Ω–µ —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏)
                        if (key.length === 1 && /[A-Za-z0-9]/.test(key)) {
                            const expectedPrefix = getExpectedPrefix();
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å + –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
                            qrInput.value = expectedPrefix + key.toUpperCase();
                            e.preventDefault();
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü
                            setTimeout(() => {
                                qrInput.setSelectionRange(qrInput.value.length, qrInput.value.length);
                                updateRegisterButton();
                            }, 0);
                        }
                    }
                });
                
                qrInput.addEventListener('input', function(e) {
                    let value = qrInput.value;
                    const cursorPosition = qrInput.selectionStart;
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Å–µ –±—É–∫–≤—ã –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
                    value = value.toUpperCase();
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–µ—Ñ–∏–∫—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const expectedPrefix = getExpectedPrefix();
                    
                    // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º –æ—à–∏–±–∫–∏
                    if (value.length === 0) {
                        updateRegisterButton();
                        return;
                    }
                    
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç –≤–≤–æ–¥–∏—Ç—å –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                    if (!value.startsWith('E') && !value.startsWith('D')) {
                        // –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª - –±—É–∫–≤–∞ –∏–ª–∏ —Ü–∏—Ñ—Ä–∞, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        if (/^[A-Z0-9]/.test(value)) {
                            value = expectedPrefix + value;
                        }
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—É—é –¥–ª–∏–Ω—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
                    const oldLength = qrInput.value.length;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                    qrInput.value = value;
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ —Å —É—á–µ—Ç–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    let newCursorPosition = cursorPosition;
                    if (value.length !== oldLength) {
                        const lengthDiff = value.length - oldLength;
                        // –ï—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏ –ø—Ä–µ—Ñ–∏–∫—Å –≤ –Ω–∞—á–∞–ª–µ, –∫—É—Ä—Å–æ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                        if (lengthDiff > 0 && cursorPosition === 0 && oldLength === 0) {
                            newCursorPosition = value.length;
                        } else if (lengthDiff > 0) {
                            // –ï—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏ —Å–∏–º–≤–æ–ª—ã, —Å–¥–≤–∏–≥–∞–µ–º –∫—É—Ä—Å–æ—Ä
                            newCursorPosition = Math.min(cursorPosition + lengthDiff, value.length);
                        } else {
                            // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Å–∏–º–≤–æ–ª—ã
                            newCursorPosition = Math.min(cursorPosition, value.length);
                        }
                    }
                    qrInput.setSelectionRange(newCursorPosition, newCursorPosition);
                    
                    const errorDiv = document.getElementById('qrError');
                    const inputWrapper = document.getElementById('qrInputWrapper');
                    if (errorDiv && errorDiv.style.display !== 'none') {
                        errorDiv.style.display = 'none';
                        if (inputWrapper) inputWrapper.classList.remove('error');
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏
                    updateRegisterButton();
                });
                
                // –¢–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ –¥—Ä—É–≥–∏–µ —Å–æ–±—ã—Ç–∏—è
                qrInput.addEventListener('change', updateRegisterButton);
                qrInput.addEventListener('paste', function(e) {
                    setTimeout(function() {
                        // –ü–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ —Ç–∞–∫–∂–µ –ø—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
                        let value = qrInput.value.toUpperCase();
                        const expectedPrefix = getExpectedPrefix();
                        
                        if (value.length > 0 && !value.startsWith('E') && !value.startsWith('D')) {
                            if (/^[A-Z0-9]/.test(value)) {
                                value = expectedPrefix + value;
                            }
                        }
                        qrInput.value = value;
                        updateRegisterButton();
                    }, 10);
                });
            }
        });

        initApp();
    </script>
</body>
</html>
