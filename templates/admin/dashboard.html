{% extends "admin/base.html" %}
{% load static %}
{% load webapp_i18n %}

{% block title %}–î–∞—à–±–æ—Ä–¥{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* ‚îÄ‚îÄ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä ‚îÄ‚îÄ */
    .global-filter-bar {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.07);
        margin-bottom: 20px;
        padding: 14px 24px;
        border-left: 4px solid #667eea;
    }
    .global-filter-form {
        display: flex;
        align-items: center;
        gap: 14px;
        flex-wrap: wrap;
    }
    .gf-label { font-size: 14px; font-weight: 700; color: #4a5568; white-space: nowrap; }
    .global-filter-form label { display: flex; align-items: center; gap: 6px; font-size: 14px; color: #4a5568; }
    .global-filter-form input[type="date"] { padding: 7px 11px; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 14px; background: white; }
    .gf-btn { padding: 8px 18px; background: linear-gradient(135deg,#667eea,#764ba2); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.15s; }
    .gf-btn:hover { transform: translateY(-1px); }
    .gf-reset { color: #718096; font-size: 13px; text-decoration: none; }
    .gf-reset:hover { color: #667eea; text-decoration: underline; }
    .gf-badge { margin-left: auto; font-size: 13px; color: #667eea; font-weight: 600; background: #ede9fe; padding: 4px 14px; border-radius: 20px; white-space: nowrap; }

    /* ‚îÄ‚îÄ –ï–¥–∏–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞ ‚îÄ‚îÄ */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 16px;
        align-items: start;
    }
    /* Panel-–∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–Ω–∏–º–∞—é—Ç 2 –∏–∑ 4 –∫–æ–ª–æ–Ω–æ–∫ ‚Üí –ø–æ–ø–∞—Ä–Ω–æ —Ä—è–¥–æ–º */
    .panel-card { grid-column: span 2; }

    @media (max-width: 1200px) {
        .dashboard-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .panel-card { grid-column: span 1; }
    }
    @media (max-width: 600px) {
        .dashboard-grid { grid-template-columns: 1fr; }
    }

    /* ‚îÄ‚îÄ –ö–∞—Ä—Ç–æ—á–∫–∏ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ / QR / –ë–∞–ª–ª—ã / –ü–æ–¥–∞—Ä–∫–∏) ‚îÄ‚îÄ */
    .dashboard-card {
        background: white;
        border-radius: 12px;
        padding: 18px 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 4px solid;
        position: relative;
        overflow: hidden;
    }
    .dashboard-card::before {
        content: ''; position: absolute; top: 0; right: 0;
        width: 80px; height: 80px;
        background: radial-gradient(circle, rgba(102,126,234,0.08) 0%, transparent 70%);
        border-radius: 50%; transform: translate(25px,-25px);
    }
    .dashboard-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }
    .dashboard-card.users   { border-left-color: #667eea; }
    .dashboard-card.qrcodes { border-left-color: #48bb78; }
    .dashboard-card.points  { border-left-color: #fbbf24; }
    .dashboard-card.gifts   { border-left-color: #ed64a6; }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏: –∏–∫–æ–Ω–∫–∞ + –Ω–∞–∑–≤–∞–Ω–∏–µ + –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
    .card-title-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e0e0e0;
    }
    .card-icon  { font-size: 20px; flex-shrink: 0; }
    .card-title { flex: 1; color: #718096; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-weight: 700; color: #2d3748; font-size: 18px; white-space: nowrap; }

    .stat-details { margin-top: 0; }
    .stat-detail-item { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; color: #4a5568; }
    .stat-detail-label { color: #718096; }
    .stat-detail-value  { font-weight: 600; color: #2d3748; }
    .filter-buttons { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .filter-button {
        display: inline-flex; align-items: center; gap: 6px;
        padding: 7px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
        color: white; text-decoration: none;
        background: linear-gradient(135deg,#667eea,#764ba2);
        box-shadow: 0 2px 4px rgba(102,126,234,0.3);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .filter-button:hover { transform: translateY(-2px); color: white; text-decoration: none; box-shadow: 0 4px 8px rgba(102,126,234,0.4); }
    .filter-button.electrician { background: linear-gradient(135deg,#fbbf24,#f59e0b); box-shadow: 0 2px 4px rgba(251,191,36,0.3); }
    .filter-button.electrician:hover { box-shadow: 0 4px 8px rgba(251,191,36,0.4); }
    .filter-button.seller { background: linear-gradient(135deg,#3b82f6,#2563eb); box-shadow: 0 2px 4px rgba(59,130,246,0.3); }
    .filter-button.seller:hover { box-shadow: 0 4px 8px rgba(59,130,246,0.4); }

    /* ‚îÄ‚îÄ –ü–∞–Ω–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–¢–æ–ø –ª–∏–¥–µ—Ä—ã / –í–∏–ª–æ—è—Ç—ã) ‚îÄ‚îÄ */
    .panel-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .panel-header {
        padding: 16px 20px;
        font-size: 16px;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg,#667eea,#764ba2);
    }
    .panel-header.electrician { background: linear-gradient(135deg,#fbbf24,#f59e0b); }
    .panel-header.seller      { background: linear-gradient(135deg,#6366f1,#4338ca); }

    /* ‚îÄ‚îÄ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ ‚îÄ‚îÄ */
    .leaders-table { width: 100%; border-collapse: collapse; }
    .leaders-table thead { background: #f8f9fa; }
    .leaders-table th { padding: 12px 16px; text-align: left; font-weight: 600; color: #4a5568; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e0e0e0; }
    .leaders-table td { padding: 14px 16px; border-bottom: 1px solid #f0f0f0; color: #2d3748; }
    .leaders-table tbody tr:hover { background: #f8f9fa; }
    .leaders-table tbody tr:last-child td { border-bottom: none; }
    .rank { font-size: 20px; font-weight: 700; color: #667eea; width: 50px; }
    .leader-name    { font-weight: 500; }
    .leader-username { color: #718096; font-size: 12px; margin-left: 8px; }
    .leader-points  { color: #667eea; font-weight: 700; font-size: 18px; text-align: right; }

    /* ‚îÄ‚îÄ –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ ‚îÄ‚îÄ */
    .report-table { width: 100%; border-collapse: collapse; }
    .report-table thead { background: #f8f9fa; }
    .report-table th { padding: 12px 16px; text-align: left; font-weight: 600; color: #4a5568; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e0e0e0; }
    .report-table th:last-child { text-align: right; }
    .report-table td { padding: 14px 16px; border-bottom: 1px solid #f0f0f0; color: #2d3748; }
    .report-table td:last-child { text-align: right; font-weight: 600; color: #667eea; }
    .report-table tbody tr:hover { background: #f8f9fa; }
    .report-table tbody tr:last-child td { border-bottom: none; }

    /* ‚îÄ‚îÄ –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚îÄ‚îÄ */
    .empty-state { padding: 40px; text-align: center; color: #718096; }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; display: block; }
</style>
{% endblock %}

{% block content %}

<!-- ‚îÄ‚îÄ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–µ—Ä–∏–æ–¥–∞ ‚îÄ‚îÄ -->
<div class="global-filter-bar">
    <form method="get" action="" class="global-filter-form">
        <span class="gf-label">üìÖ –ü–µ—Ä–∏–æ–¥:</span>
        <label>–° <input type="date" name="date_from" value="{{ date_from }}"></label>
        <label>–ü–æ <input type="date" name="date_to" value="{{ date_to }}"></label>
        <button type="submit" class="gf-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <a href="?" class="gf-reset">‚úï –°–±—Ä–æ—Å–∏—Ç—å</a>
        <span class="gf-badge">{{ period_label }}</span>
    </form>
</div>

<!-- ‚îÄ‚îÄ –ï–¥–∏–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞ ‚îÄ‚îÄ -->
<div class="dashboard-grid">

    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div class="dashboard-card users">
        <div class="card-title-row">
            <span class="card-icon">üë•</span>
            <span class="card-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
            <span class="stat-value">{{ total_users }}</span>
        </div>
        <div class="stat-details">
            <div class="stat-detail-item">
                <span class="stat-detail-label">‚ö° –≠–ª–µ–∫—Ç—Ä–∏–∫–∏:</span>
                <span class="stat-detail-value">{{ total_electricians }}</span>
            </div>
            <div class="stat-detail-item">
                <span class="stat-detail-label">üõí –ü—Ä–æ–¥–∞–≤—Ü—ã:</span>
                <span class="stat-detail-value">{{ total_sellers }}</span>
            </div>
        </div>
        <div class="filter-buttons">
            <a href="{% url 'admin:core_telegramuser_changelist' %}?user_type__exact=electrician" class="filter-button electrician">‚ö° –≠–ª–µ–∫—Ç—Ä–∏–∫–∏</a>
            <a href="{% url 'admin:core_telegramuser_changelist' %}?user_type__exact=seller" class="filter-button seller">üõí –ü—Ä–æ–¥–∞–≤—Ü—ã</a>
            {% if perms.core.send_region_messages %}
            <a href="{% url 'admin:core_telegramuser_send_region_message' %}" class="filter-button">üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ –æ–±–ª–∞—Å—Ç–∏</a>
            {% endif %}
        </div>
    </div>

    <!-- QR-–∫–æ–¥—ã -->
    <div class="dashboard-card qrcodes">
        <div class="card-title-row">
            <span class="card-icon">üì±</span>
            <span class="card-title">QR-–∫–æ–¥—ã</span>
            <span class="stat-value">{{ total_qrcodes }}</span>
        </div>
        <div class="stat-details">
            <div class="stat-detail-item">
                <span class="stat-detail-label">‚úÖ –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:</span>
                <span class="stat-detail-value" style="color:#48bb78;">{{ scanned_qrcodes }}</span>
            </div>
            <div class="stat-detail-item">
                <span class="stat-detail-label">‚è≥ –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:</span>
                <span class="stat-detail-value" style="color:#fbbf24;">{{ unscanned_qrcodes }}</span>
            </div>
        </div>
    </div>

    <!-- –ë–∞–ª–ª—ã -->
    <div class="dashboard-card points">
        <div class="card-title-row">
            <span class="card-icon">üí∞</span>
            <span class="card-title">–ë–∞–ª–ª—ã</span>
            <span class="stat-value">{{ total_points_electricians|add:total_points_sellers|format_number }}</span>
        </div>
        <div class="stat-details">
            <div class="stat-detail-item">
                <span class="stat-detail-label">‚ö° –≠–ª–µ–∫—Ç—Ä–∏–∫–∏:</span>
                <span class="stat-detail-value" style="color:#fbbf24;">{{ total_points_electricians|format_number }}</span>
            </div>
            <div class="stat-detail-item">
                <span class="stat-detail-label">üõí –ü—Ä–æ–¥–∞–≤—Ü—ã:</span>
                <span class="stat-detail-value" style="color:#fbbf24;">{{ total_points_sellers|format_number }}</span>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∞—Ä–∫–∏ -->
    <div class="dashboard-card gifts">
        <div class="card-title-row">
            <span class="card-icon">üéÅ</span>
            <span class="card-title">–ü–æ–¥–∞—Ä–∫–∏</span>
            <span class="stat-value">{{ total_gifts }}</span>
        </div>
        <div class="stat-details">
            <div class="stat-detail-item">
                <span class="stat-detail-label">‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö:</span>
                <span class="stat-detail-value" style="color:#48bb78;">{{ active_gifts }}</span>
            </div>
            <div class="stat-detail-item">
                <span class="stat-detail-label">‚è≥ –û–∂–∏–¥–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏:</span>
                <span class="stat-detail-value" style="color:#ed64a6;">{{ pending_redemptions }}</span>
            </div>
        </div>
    </div>

    <!-- –¢–û–ü-10 –≠–ª–µ–∫—Ç—Ä–∏–∫–∏ -->
    <div class="panel-card">
        <div class="panel-header electrician">üèÜ –¢–û–ü-10 –õ–∏–¥–µ—Ä–æ–≤ (–≠–ª–µ–∫—Ç—Ä–∏–∫–∏)</div>
        <table class="leaders-table">
            <thead>
                <tr>
                    <th style="width:60px;">–ú–µ—Å—Ç–æ</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th style="text-align:right;">–ë–∞–ª–ª—ã</th>
                </tr>
            </thead>
            <tbody>
                {% for leader in top_electricians %}
                <tr>
                    <td class="rank">{% if forloop.counter == 1 %}ü•á{% elif forloop.counter == 2 %}ü•à{% elif forloop.counter == 3 %}ü•â{% else %}{{ forloop.counter }}{% endif %}</td>
                    <td class="leader-name">{{ leader.first_name|default:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" }}<span class="leader-username">@{{ leader.username|default:"N/A" }}</span></td>
                    <td class="leader-points">{{ leader.points|format_number }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="empty-state"><span class="empty-state-icon">üòî</span><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –¢–û–ü-10 –ü—Ä–æ–¥–∞–≤—Ü—ã -->
    <div class="panel-card">
        <div class="panel-header seller">üèÜ –¢–û–ü-10 –õ–∏–¥–µ—Ä–æ–≤ (–ü—Ä–æ–¥–∞–≤—Ü—ã)</div>
        <table class="leaders-table">
            <thead>
                <tr>
                    <th style="width:60px;">–ú–µ—Å—Ç–æ</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th style="text-align:right;">–ë–∞–ª–ª—ã</th>
                </tr>
            </thead>
            <tbody>
                {% for leader in top_sellers %}
                <tr>
                    <td class="rank">{% if forloop.counter == 1 %}ü•á{% elif forloop.counter == 2 %}ü•à{% elif forloop.counter == 3 %}ü•â{% else %}{{ forloop.counter }}{% endif %}</td>
                    <td class="leader-name">{{ leader.first_name|default:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" }}<span class="leader-username">@{{ leader.username|default:"N/A" }}</span></td>
                    <td class="leader-points">{{ leader.points|format_number }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="empty-state"><span class="empty-state-icon">üòî</span><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –í–∏–ª–æ—è—Ç—ã: –≠–ª–µ–∫—Ç—Ä–∏–∫–∏ -->
    <div class="panel-card">
        <div class="panel-header electrician">‚ö° –≠–ª–µ–∫—Ç—Ä–∏–∫–∏ ‚Äî –≤–∏–ª–æ—è—Ç—ã</div>
        <table class="report-table">
            <thead>
                <tr>
                    <th>–í–∏–ª–æ—è—Ç</th>
                    <th style="text-align:right;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</th>
                    <th style="text-align:right;">–ë–∞–ª–ª—ã</th>
                </tr>
            </thead>
            <tbody>
                {% for region_name, user_count, points in regions_electrician %}
                <tr>
                    <td>{{ region_name }}</td>
                    <td style="text-align:right;">{{ user_count|format_number }}</td>
                    <td style="text-align:right;">{{ points|format_number }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="empty-state"><span class="empty-state-icon">üòî</span><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –í–∏–ª–æ—è—Ç—ã: –ü—Ä–æ–¥–∞–≤—Ü—ã -->
    <div class="panel-card">
        <div class="panel-header seller">üõí –ü—Ä–æ–¥–∞–≤—Ü—ã ‚Äî –≤–∏–ª–æ—è—Ç—ã</div>
        <table class="report-table">
            <thead>
                <tr>
                    <th>–í–∏–ª–æ—è—Ç</th>
                    <th style="text-align:right;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</th>
                    <th style="text-align:right;">–ë–∞–ª–ª—ã</th>
                </tr>
            </thead>
            <tbody>
                {% for region_name, user_count, points in regions_seller %}
                <tr>
                    <td>{{ region_name }}</td>
                    <td style="text-align:right;">{{ user_count|format_number }}</td>
                    <td style="text-align:right;">{{ points|format_number }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="empty-state"><span class="empty-state-icon">üòî</span><div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}
